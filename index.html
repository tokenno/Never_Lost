<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spin - Motorcycle GPS Locator</title>
  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary-color: #ff6600;
      --secondary-color: #333;
      --accent-color: #00ccff;
      --text-color: #fff;
      --warning-color: #ffcc00;
      --error-color: #ff3333;
      --success-color: #00cc66;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: var(--text-color);
      text-align: center;
      padding: 1em;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
      position: relative;
    }
    
    .app-title {
      font-size: 2.2em;
      margin: 0;
      color: var(--primary-color);
      text-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
    }
    
    .wheel-container {
      position: relative;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .spinning-wheel {
      width: 50px;
      height: 50px;
      position: relative;
      animation: wheel-spin 3s linear infinite;
    }
    
    .wheel-outer {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 3;
      stroke-dasharray: 5;
      animation: wheel-dash 1s linear infinite;
    }
    
    .wheel-inner {
      fill: none;
      stroke: var(--accent-color);
      stroke-width: 2;
    }
    
    .wheel-spoke {
      stroke: var(--accent-color);
      stroke-width: 2;
      transform-origin: center;
    }
    
    .spoke-1 { animation: spoke-spin 4s linear infinite; }
    .spoke-2 { animation: spoke-spin 3s linear infinite reverse; }
    .spoke-3 { animation: spoke-spin 5s linear infinite; }
    
    @keyframes wheel-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes wheel-dash {
      to { stroke-dashoffset: -10; }
    }
    
    @keyframes spoke-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .wheel-pulse {
      fill: var(--primary-color);
      animation: wheel-pulse 2s ease-in-out infinite;
    }
    
    @keyframes wheel-pulse {
      0%, 100% { opacity: 0.7; transform: scale(0.95); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .dashboard-item {
      background: rgba(40, 40, 40, 0.7);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #444;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .dashboard-value {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--accent-color);
      margin: 5px 0;
    }
    
    .dashboard-label {
      font-size: 0.9em;
      color: #aaa;
    }
    
    .panel {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .control-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    
    input, button, select, textarea {
      margin: 0.5em;
      padding: 0.7em 1em;
      font-size: 1em;
      background: #333;
      color: var(--text-color);
      border: 1px solid #555;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    button {
      cursor: pointer;
      background: linear-gradient(to bottom, #444, #333);
      font-weight: bold;
    }
    
    button:hover:not(:disabled) {
      background: linear-gradient(to bottom, #555, #444);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .primary-btn {
      background: linear-gradient(to bottom, var(--primary-color), #e55d00);
      color: #fff;
      border: 1px solid #ff8533;
    }
    
    .secondary-btn {
      background: linear-gradient(to bottom, #555, #444);
      color: #fff;
    }
    
    .warning-btn {
      background: linear-gradient(to bottom, var(--warning-color), #e6b800);
      color: #000;
    }
    
    .emergency-btn {
      background: linear-gradient(to bottom, var(--error-color), #cc0000);
      color: #fff;
      animation: pulse-emergency 2s infinite;
    }
    
    @keyframes pulse-emergency {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #debug {
      text-align: left;
      margin: 20px auto;
      padding: 10px;
      border: 1px dashed #555;
      color: #aaa;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9em;
      background: rgba(20, 20, 20, 0.8);
      border-radius: 5px;
    }
    
    .status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .success {
      background: rgba(0, 204, 102, 0.2);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }
    
    .error {
      background: rgba(255, 51, 51, 0.2);
      border: 1px solid var(--error-color);
      color: var(--error-color);
    }
    
    .warning {
      background: rgba(255, 204, 0, 0.2);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }
    
    .speed-indicator {
      font-size: 1em;
      margin-top: 5px;
      color: var(--accent-color);
      font-weight: bold;
    }
    
    .auto-lock-settings {
      margin-top: 10px;
      padding: 10px;
      border-top: 1px dashed #555;
    }
    
    .slider-label {
      display: inline-flex;
      align-items: center;
      margin-left: 5px;
      color: var(--accent-color);
    }
    
    .direction-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 10px auto;
    }
    
    #directionArrow {
      width: 0; 
      height: 0; 
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 40px solid var(--primary-color);
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 50% 0;
      transform: translate(-50%, -50%) rotate(0deg);
      transition: transform 0.3s ease;
    }
    
    .direction-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 1px dashed var(--accent-color);
      border-radius: 50%;
      top: 0;
      left: 0;
      box-sizing: border-box;
    }
    
    .direction-status {
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    #map {
      height: 250px;
      width: 100%;
      background: #222;
      border: 1px solid #555;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .user-marker, .lock-marker {
      font-size: 20px;
      text-shadow: 0 0 3px #000;
    }
    
    .leaflet-control-attribution {
      background: rgba(0, 0, 0, 0.7) !important;
      color: #aaa !important;
      font-family: monospace;
      font-size: 0.8em;
    }
    
    .reached-message {
      color: var(--success-color);
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    
    button.muted {
      background: #f00 !important;
      color: #fff !important;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .lean-container {
      position: relative;
      width: 200px;
      height: 100px;
      margin: 10px auto;
      background: rgba(50, 50, 50, 0.7);
      border-radius: 100px 100px 0 0;
      overflow: hidden;
    }
    
    .lean-bike {
      position: absolute;
      width: 40px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 10px 10px 0 0;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.1s ease;
    }
    
    .lean-scale {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-around;
    }
    
    .lean-mark {
      width: 1px;
      height: 10px;
      background: #666;
      position: relative;
      top: 10px;
    }
    
    .lean-mark:nth-child(6) {
      height: 20px;
      background: var(--accent-color);
    }
    
    .lean-value {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      color: var(--accent-color);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      background: rgba(50, 50, 50, 0.7);
    }
    
    .tab.active {
      background: rgba(30, 30, 30, 0.9);
      border-color: #444;
      border-bottom: 1px solid rgba(30, 30, 30, 0.9);
      margin-bottom: -1px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .maintenance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 5px;
    }
    
    .maintenance-progress {
      height: 10px;
      background: #333;
      border-radius: 5px;
      flex-grow: 1;
      margin: 0 10px;
      overflow: hidden;
    }
    
    .maintenance-progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--success-color), var(--warning-color), var(--error-color));
      border-radius: 5px;
    }
    
    .emergency-panel {
      background: rgba(204, 0, 0, 0.2);
      border: 1px solid var(--error-color);
    }
    
    .emergency-contacts {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }
    
    .contact-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: rgba(50, 50, 50, 0.7);
      border-radius: 5px;
      min-width: 120px;
    }
    
    .collapsible {
      cursor: pointer;
      padding: 10px;
      border: none;
      text-align: center;
      outline: none;
      font-size: 1em;
      color: var(--primary-color);
      background: transparent;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .collapsible:after {
      content: '▼';
      font-size: 0.8em;
      margin-left: 5px;
      transition: transform 0.2s;
    }
    
    .collapsible.active:after {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      padding: 0 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }
    
    .corner-analysis {
      margin: 10px 0;
      padding: 10px;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 5px;
      text-align: left;
    }
    
    .elevation-profile {
      height: 150px;
      background: #333;
      border-radius: 5px;
      margin: 10px 0;
      position: relative;
    }
    
    #newMaintenanceName, #newMaintenanceInterval, #saveMaintenanceBtn {
      display: none;
    }
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .app-header {
        flex-direction: column;
      }
      
      .control-group {
        flex-direction: column;
        align-items: center;
      }
      
      .wheel-container {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h1 class="app-title">Spin</h1>
    <div class="wheel-container">
      <svg class="spinning-wheel" viewBox="0 0 100 100">
        <circle class="wheel-outer" cx="50" cy="50" r="40" />
        <circle class="wheel-inner" cx="50" cy="50" r="25" />
        <line class="wheel-spoke spoke-1" x1="50" y1="50" x2="75" y2="50" />
        <line class="wheel-spoke spoke-2" x1="50" y1="50" x2="50" y2="25" />
        <line class="wheel-spoke spoke-3" x1="50" y1="50" x2="30" y2="70" />
        <circle class="wheel-pulse" cx="50" cy="50" r="8" />
      </svg>
    </div>
  </div>

  <div class="dashboard">
    <div class="dashboard-item">
      <div class="dashboard-label">Current Speed</div>
      <div class="dashboard-value" id="currentSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Max Speed</div>
      <div class="dashboard-value" id="maxSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Average Speed</div>
      <div class="dashboard-value" id="avgSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Current Lean Angle</div>
      <div class="dashboard-value" id="leanAngle">--°</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Today's Distance</div>
      <div class="dashboard-value" id="todayDistance">-- km</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Elevation Gain</div>
      <div class="dashboard-value" id="elevationGain">-- m</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Max Cornering Speed</div>
      <div class="dashboard-value" id="maxCornerSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Max Corner G</div>
      <div class="dashboard-value" id="maxCornerG">-- g</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Avg Corner Entry Speed</div>
      <div class="dashboard-value" id="avgCornerEntrySpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">0-100 km/h</div>
      <div class="dashboard-value" id="accelerationTime">-- s</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="navigation">Navigation</div>
    <div class="tab" data-tab="metrics">Ride Metrics</div>
    <div class="tab" data-tab="emergency">Emergency</div>
    <div class="tab" data-tab="maintenance">Maintenance</div>
  </div>

  <div class="tab-content active" id="navigation-tab">
    <div class="panel">
      <h2>GPS Navigation</h2>
      <p class="warning">TAP "TEST AUDIO & LOCK" FIRST!</p>

      <div class="control-group">
        <button id="testBtn" class="primary-btn">Test Audio & Lock</button>
        <button id="calibrateBtn" class="secondary-btn">Calibrate Sensors</button>
        <button id="autoLockBtn" class="secondary-btn" disabled>Auto-Lock Mode</button>
        <button id="muteBtn" class="secondary-btn" disabled>Mute Sound</button>
        <button id="stopGpsLockBtn" class="secondary-btn" disabled>Stop GPS Lock</button>
      </div>
      
      <div id="autoLockSettings" style="display: none;">
        <div class="control-group">
          <div class="control-item">
            <label for="stationaryTime">Stationary Confirmation Time</label>
            <div>
              <input type="range" id="stationaryTime" value="30" min="5" max="60" />
              <span id="stationaryTimeValue" class="slider-label">30 sec</span>
            </div>
          </div>
          <div class="control-item">
            <label for="speedThreshold">Speed Threshold (km/h)</label>
            <div>
              <input type="range" id="speedThreshold" value="10" min="5" max="20" />
              <span id="speedThresholdValue" class="slider-label">10 km/h</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="calibrateStatus" class="status">Sensors not calibrated</div>
      <div id="lockStatus" class="status">Lock Status: Not locked</div>
      <div id="audioStatus" class="status">Audio: Not initialized</div>
      <div id="gpsStatus" class="status">GPS: Ready</div>
      <div id="reachedMessage" class="reached-message" style="display: none;">You have reached GPS locked point!</div>
    </div>

    <div class="panel">
      <h2>Position Map</h2>
      <div id="map"></div>
    </div>

    <div class="panel">
      <button class="collapsible">Direction Indicator ▼</button>
      <div class="collapsible-content">
        <div class="direction-container">
          <div id="directionArrow"></div>
          <div class="direction-circle"></div>
        </div>
        <div id="directionStatus" class="direction-status">Direction: --</div>
      </div>

      <button class="collapsible">Sonar Parameters ▼</button>
      <div class="collapsible-content">
        <div class="control-group">
          <div class="control-item">
            <label for="freqInput">Bleep Freq (Hz)</label><br>
            <input type="number" id="freqInput" value="800" min="20" max="20000" />
          </div>
          <div class="control-item">
            <label for="maxDistInput">Max Distance (m)</label><br>
            <input type="range" id="maxDistInput" value="50" min="1" max="500" />
            <span id="maxDistValue">50</span> m
          </div>
        </div>
      </div>

      <button class="collapsible">Data Output ▼</button>
      <div class="collapsible-content">
        <div class="control-group">
          <div class="control-item">
            <label>Distance</label><br>
            <span id="distance">--</span> m
          </div>
          <div class="control-item">
            <label>Accuracy</label><br>
            <span id="accuracy">--</span> m
          </div>
          <div class="control-item">
            <label>BPM</label><br>
            <span id="bleepRate">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="metrics-tab">
    <div class="panel">
      <h2>Ride Metrics</h2>
      
      <div class="control-group">
        <button id="startRideBtn" class="primary-btn">Start Ride</button>
        <button id="stopRideBtn" class="secondary-btn" disabled>Stop Ride</button>
        <button id="resetMetricsBtn" class="secondary-btn">Reset Metrics</button>
        <button id="exportMetricsBtn" class="secondary-btn">Export Data</button>
      </div>

      <div class="control-group">
        <div class="control-item">
          <label for="accelTarget">Acceleration Target (km/h)</label><br>
          <input type="number" id="accelTarget" value="100" min="10" max="200" />
        </div>
      </div>
      
      <div class="lean-container">
        <div class="lean-scale">
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
        </div>
        <div class="lean-bike" id="leanBike"></div>
        <div class="lean-value" id="leanValue">0°</div>
      </div>

      <div class="corner-analysis">
        <h3>Cornering Analysis</h3>
        <p>Current Corner G: <span id="currentCornerG">0 g</span></p>
        <p>Max Corner Speed: <span id="maxCornerSpeed">0 km/h</span></p>
        <p>Avg Corner Lean: <span id="avgCornerLean">0°</span></p>
        <canvas id="cornerChart" width="100%" height="150"></canvas>
        <div id="cornerList">No corners detected yet.</div>
      </div>

      <div class="elevation-profile">
        <h3>Elevation Profile</h3>
        <canvas id="elevationCanvas" width="100%" height="150"></canvas>
        <p>Total Elevation Gain: <span id="totalElevationGain">0 m</span></p>
        <p>Max Elevation: <span id="maxElevation">0 m</span></p>
        <p>Min Elevation: <span id="minElevation">0 m</span></p>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <h3>Distance Statistics</h3>
          <div>Today: <span id="statsToday">0 km</span></div>
          <div>This Week: <span id="statsWeek">0 km</span></div>
          <div>This Month: <span id="statsMonth">0 km</span></div>
          <div>Total: <span id="statsTotal">0 km</span></div>
        </div>
        
        <div class="control-item">
          <h3>Speed Statistics</h3>
          <div>Current: <span id="statsCurrentSpeed">0 km/h</span></div>
          <div>Average: <span id="statsAvgSpeed">0 km/h</span></div>
          <div>Max: <span id="statsMaxSpeed">0 km/h</span></div>
          <div>0-100 km/h: <span id="statsAcceleration">-- s</span></div>
        </div>
      </div>
      
      <div class="control-item">
        <h3>Ride History</h3>
        <div id="rideHistory" style="max-height: 200px; overflow-y: auto; text-align: left; padding: 10px; background: rgba(40,40,40,0.7); border-radius: 5px;">
          No ride history yet.
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="emergency-tab">
    <div class="panel emergency-panel">
      <h2>Emergency Features</h2>
      
      <div class="control-group">
        <button id="emergencyBtn" class="emergency-btn">EMERGENCY ALERT</button>
      </div>
      
      <div id="crashStatus" class="status">Crash Detection: Inactive</div>
      
      <div class="control-group">
        <div class="control-item">
          <label for="emergencyMessage">Emergency Message</label><br>
          <textarea id="emergencyMessage" rows="3" style="width: 100%;">I need help! My current location is: </textarea>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <label for="emergencyContacts">Emergency Contacts (comma-separated phone numbers)</label><br>
          <input type="text" id="emergencyContacts" value="" placeholder="+1234567890,+0987654321" style="width: 100%;" />
        </div>
        <div class="control-item">
          <label for="messengerContacts">Messenger Contacts (comma-separated Facebook Page IDs/usernames)</label><br>
          <input type="text" id="messengerContacts" value="" placeholder="yourpage,friendusername" style="width: 100%;" />
        </div>
      </div>
      
      <h3>Quick Contact</h3>
      <div class="emergency-contacts" id="emergencyContactList">
      </div>
      
      <div class="control-group">
        <button id="testEmergencyBtn" class="warning-btn">Test Emergency</button>
        <button id="addContactBtn" class="secondary-btn">Add Contact</button>
        <button id="sendMessengerBtn" class="secondary-btn">Send via Messenger</button>
      </div>
    </div>
  </div>

  <div class="tab-content" id="maintenance-tab">
    <div class="panel">
      <h2>Maintenance Alerts</h2>
      
      <div class="control-group">
        <button id="addMaintenanceBtn" class="primary-btn">Add Maintenance Item</button>
        <button id="resetMaintenanceBtn" class="secondary-btn">Reset All</button>
      </div>
      
      <div id="maintenanceList">
        <div class="maintenance-item">
          <div>Oil Change</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 30%;"></div>
          </div>
          <div>2000/5000 km</div>
        </div>
        
        <div class="maintenance-item">
          <div>Tire Pressure</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 70%;"></div>
          </div>
          <div>Check weekly</div>
        </div>
        
        <div class="maintenance-item">
          <div>Chain Lubrication</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 50%;"></div>
          </div>
          <div>500/1000 km</div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <h3>Add New Maintenance Item</h3>
          <input type="text" id="newMaintenanceName" placeholder="Item name" />
          <input type="number" id="newMaintenanceInterval" placeholder="Interval (km)" />
          <button id="saveMaintenanceBtn" class="secondary-btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2 class="help-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
      Help Guide ▼
    </h2>
    <div id="helpContent" style="display: none; text-align: left; padding: 10px;">
      <h1>Spin</h1>
      <h2>Purpose:</h2>
      Motorcycle-focused GPS navigation with ride metrics, emergency features, and maintenance tracking. The spinning wheel in the header rotates to reflect your current speed, spinning faster as you ride faster.

      <h2>Navigation Tab</h2>
      <strong>GPS Navigation:</strong> Lock your position and navigate back with audio cues using "Test Audio & Lock". Stop the GPS lock with "Stop GPS Lock".<br>
      <strong>Calibrate Sensors:</strong> Place phone on bike in riding position and tap to set baseline for lean angle and crash detection.<br>
      <strong>Auto-Lock Mode:</strong> Automatically locks position when motorcycle is stationary.<br>
      <strong>Direction Indicator:</strong> Visual compass pointing to locked position.<br>
      <strong>Sonar Parameters:</strong> Adjust audio feedback frequency and range.

      <h2>Metrics Tab</h2>
      <strong>Ride Metrics:</strong> Track speed, distance, acceleration, and lean angles with real-time updates. Start a ride with "Start Ride" and end it with "Stop Ride".<br>
      <strong>Cornering Analysis:</strong> Detects corners using GPS curvature and lean angle, calculates cornering G and speeds.<br>
      <strong>Elevation Gain:</strong> Tracks altitude changes using GPS data, with a profile chart.<br>
      <strong>Lean Angle Indicator:</strong> Visual display of motorcycle lean during corners, updated rapidly for responsiveness.<br>
      <strong>Distance Statistics:</strong> Daily, weekly, monthly, and total distance tracking.<br>
      <strong>Acceleration Timer:</strong> Measures 0-100 km/h acceleration.

      <h2>Emergency Tab</h2>
      <strong>Emergency Alert:</strong> Send your location to emergency contacts (phone or Messenger) manually via "EMERGENCY ALERT".<br>
      <strong>Messenger Alert:</strong> Send a pre-filled message via Facebook Messenger to specified Page IDs or usernames using "Send via Messenger".<br>
      <strong>Crash Detection:</strong> Automatically sends location to all contacts (phone and Messenger) if bike is detected lying flat for 5 seconds.<br>
      <strong>Quick Contacts:</strong> Pre-set phone numbers and Messenger contacts (Facebook Page IDs or usernames) for quick access.<br>
      <strong>Custom Message:</strong> Edit the emergency message with your details.

      <h2>Maintenance Tab</h2>
      <strong>Maintenance Alerts:</strong> Track service intervals based on mileage.<br>
      <strong>Progress Indicators:</strong> Visual progress bars for each maintenance item.<br>
      <strong>Custom Items:</strong> Add your own maintenance tasks and intervals.

      <h2>Quick Start</h2>
      1. Mount phone securely and tap "Calibrate Sensors" to set lean angle and crash detection baseline.<br>
      2. Set emergency contacts (phone numbers and Messenger IDs) in the Emergency tab.<br>
      3. Tap "Test Audio & Lock" in the Navigation tab to lock your parking position.<br>
      4. Start a ride in the Metrics tab to track performance; watch the header wheel spin with your speed.<br>
      5. Stop the ride in the Metrics tab to save data, or stop the GPS lock in the Navigation tab to end navigation.<br>
      6. Add maintenance schedules in the Maintenance tab.

      <h2>Tips</h2>
      - For accurate lean angles and crash detection, mount your phone securely on the motorcycle and calibrate sensors.<br>
      - Set up emergency contacts before your first ride to enable crash detection alerts.<br>
      - For Messenger alerts, use a Facebook Page ID/username or friend’s username (must be a friend on Facebook).<br>
      - Regular maintenance alerts help keep your motorcycle in top condition.<br>
      - Export your ride data to track your riding habits over time.
    </div>
  </div>

  <div id="debug"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script>
const MotoFindBack = {
  audioCtx: null,
  watchId: null,
  bleepTimer: null,
  lockPosition: null,
  lastUpdateTime: Date.now(),
  lastBleedTime: 0,
  isAudioAllowed: false,
  isActive: false,
  isRideActive: false,
  movementHistory: [],
  currentTempo: 1000,
  autoLockEnabled: false,
  autoLockDebounce: null,
  currentSpeed: 0,
  reachedPointDisplayed: false,
  isMuted: false,
  isStationary: false,
  lastStationaryTime: null,
  lastStationaryPosition: null,
  speedThreshold: 10,
  maxSpeed: 0,
  totalDistance: 0,
  todayDistance: 0,
  weekDistance: 0,
  monthDistance: 0,
  elevationGain: 0,
  rideStartTime: null,
  accelerationStartTime: null,
  accelerationStartSpeed: 0,
  accelerationTimes: [],
  maxLeanAngle: 0,
  currentLeanAngle: 0,
  currentCornerG: 0,
  maxCornerG: 0,
  maxCornerSpeed: 0,
  corners: [],
  cornerEntrySpeeds: [],
  cornerExitSpeeds: [],
  maintenanceItems: [],
  emergencyContacts: [],
  rideHistory: [],
  isCalibrating: false,
  calibrationSamples: [],
  leanOffset: 0,
  crashDetected: false,
  crashStartTime: null,
  lastPosition: null,
  prevPosition: null,
  rotationSpeed: 0,
  map: null,
  userMarker: null,
  lockMarker: null,
  line: null,
  accelTarget: 100,
  elevationHistory: [],
  canvas: null,
  cornerChart: null,

  log: function(message, isError = false) {
    const debug = document.getElementById("debug");
    debug.innerHTML += `<div style="color: ${isError ? '#ff3333' : '#aaa'}">${new Date().toLocaleTimeString()}: ${message}</div>`;
    debug.scrollTop = debug.scrollHeight;
  },

  init: async function() {
    this.initMap();
    this.canvas = document.getElementById('elevationCanvas');
    if (!this.canvas) {
      this.log("Error: elevationCanvas element not found", true);
      return;
    }
    this.cornerChart = new Chart(document.getElementById('cornerChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Corner G-Force',
          data: [],
          borderColor: '#00ccff',
          backgroundColor: 'rgba(0, 204, 255, 0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'G-Force (g)' } },
          x: { title: { display: true, text: 'Corner Number' } }
        }
      }
    });
    this.setupEventListeners();
    this.setupTabs();
    this.setupCollapsibles();
    this.loadData();
    this.updateUI();
    this.log("MotoFindBack initialized");
    this.initDeviceOrientation();

    document.getElementById("maxDistInput").addEventListener("input", (e) => {
      document.getElementById("maxDistValue").textContent = e.target.value;
    });

    document.getElementById("stationaryTime").addEventListener("input", (e) => {
      document.getElementById("stationaryTimeValue").textContent = e.target.value + ' sec';
    });

    document.getElementById("speedThreshold").addEventListener("input", (e) => {
      this.speedThreshold = parseFloat(e.target.value);
      document.getElementById("speedThresholdValue").textContent = e.target.value + ' km/h';
    });

    document.getElementById("accelTarget").addEventListener("input", (e) => {
      this.accelTarget = parseFloat(e.target.value) || 100;
      const label = document.querySelector('#accelerationTime').previousElementSibling;
      if (label) label.textContent = `0-${this.accelTarget} km/h`;
      const statsLabel = document.querySelector('#statsAcceleration').previousElementSibling;
      if (statsLabel) statsLabel.textContent = `0-${this.accelTarget} km/h`;
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        this.log('Service Worker registered');
      }).catch(err => {
        this.log('Service Worker registration failed: ' + err, true);
      });
    }
  },

  initMap: function() {
    this.map = L.map('map', { zoomControl: true }).setView([51.505, -0.09], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19
    }).addTo(this.map);

    const userIcon = L.divIcon({ className: 'user-marker', html: '📍', iconSize: [24, 24] });
    const lockIcon = L.divIcon({ className: 'lock-marker', html: '🔒', iconSize: [24, 24] });
    this.userMarker = L.marker([0, 0], { icon: userIcon }).addTo(this.map);
    this.lockMarker = L.marker([0, 0], { icon: lockIcon }).addTo(this.map);
    this.line = L.polyline([], { color: '#ff6600', weight: 2 }).addTo(this.map);

    setTimeout(() => {
      this.map.invalidateSize();
      this.log("Map initialized and redrawn");
    }, 100);

    document.querySelector('.tab[data-tab="navigation"]').addEventListener('click', () => {
      setTimeout(() => {
        this.map.invalidateSize();
        this.log("Map redrawn on Navigation tab activation");
      }, 100);
    });
  },

  setupTabs: function() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        if (tab.dataset.tab === 'navigation' && this.map) {
          setTimeout(() => {
            this.map.invalidateSize();
            this.log("Map redrawn on Navigation tab switch");
          }, 100);
        }
      });
    });
  },

  setupCollapsibles: function() {
    const coll = document.getElementsByClassName("collapsible");
    for (let i = 0; i < coll.length; i++) {
      coll[i].addEventListener("click", function() {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
      });
    }
  },

  setupEventListeners: function() {
    document.getElementById("testBtn").addEventListener("click", () => {
      this.initAudio();
      this.playTestSound();
      if (this.isAudioAllowed) {
        this.lockCurrentPosition();
        document.getElementById("stopGpsLockBtn").disabled = false;
      }
    });
    document.getElementById("calibrateBtn").addEventListener("click", () => this.calibrateSensors());
    document.getElementById("autoLockBtn").addEventListener("click", () => this.toggleAutoLock());
    document.getElementById("muteBtn").addEventListener("click", () => this.toggleMute());
    document.getElementById("stopGpsLockBtn").addEventListener("click", () => this.stop());
    document.getElementById("startRideBtn").addEventListener("click", () => this.startRide());
    document.getElementById("stopRideBtn").addEventListener("click", () => this.stopRide());
    document.getElementById("resetMetricsBtn").addEventListener("click", () => this.resetMetrics());
    document.getElementById("exportMetricsBtn").addEventListener("click", () => this.exportMetrics());
    document.getElementById("emergencyBtn").addEventListener("click", () => this.sendEmergencyAlert());
    document.getElementById("testEmergencyBtn").addEventListener("click", () => this.testEmergency());
    document.getElementById("addContactBtn").addEventListener("click", () => this.addEmergencyContact());
    document.getElementById("sendMessengerBtn").addEventListener("click", () => this.sendMessengerAlert());
    document.getElementById("addMaintenanceBtn").addEventListener("click", () => this.showMaintenanceForm());
    document.getElementById("resetMaintenanceBtn").addEventListener("click", () => this.resetMaintenance());
    document.getElementById("saveMaintenanceBtn").addEventListener("click", () => this.saveMaintenanceItem());
  },

  initAudio: function() {
    if (!this.audioCtx) {
      this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      document.getElementById("audioStatus").textContent = "Audio: Initialized";
      document.getElementById("audioStatus").className = "status success";
      this.isAudioAllowed = true;
      this.log("Audio context initialized");
    }
  },

  playTestSound: function() {
    if (this.audioCtx && !this.isMuted) {
      const oscillator = this.audioCtx.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(440, this.audioCtx.currentTime);
      oscillator.connect(this.audioCtx.destination);
      oscillator.start();
      oscillator.stop(this.audioCtx.currentTime + 0.5);
      this.log("Test sound played");
    }
  },

  playBleep: function() {
    if (this.audioCtx && !this.isMuted && this.isActive) {
      const now = Date.now();
      if (now - this.lastBleedTime >= this.currentTempo) {
        const freq = parseFloat(document.getElementById("freqInput").value) || 800;
        const oscillator = this.audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(freq, this.audioCtx.currentTime);
        oscillator.connect(this.audioCtx.destination);
        oscillator.start();
        oscillator.stop(this.audioCtx.currentTime + 0.1);
        this.lastBleedTime = now;
        this.bleepTimer = setTimeout(() => this.playBleep(), this.currentTempo);
      }
    }
  },

  calculateTempo: function(distance) {
    const maxDist = parseFloat(document.getElementById("maxDistInput").value) || 50;
    return Math.max(100, Math.min(1000, (distance / maxDist) * 1000));
  },

  calculateDistance: function(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c / 1000; // Distance in kilometers
  },

  calculateBearing: function(lat1, lon1, lat2, lon2) {
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    return (θ * 180 / Math.PI + 360) % 360;
  },

  lockCurrentPosition: function() {
    if (navigator.geolocation) {
      this.watchId = navigator.geolocation.watchPosition(
        (position) => {
          this.isActive = true;
          if (!this.lockPosition) {
            this.lockPosition = {
              lat: position.coords.latitude,
              lon: position.coords.longitude
            };
            document.getElementById("lockStatus").textContent = `Lock Status: Locked at Lat ${this.lockPosition.lat.toFixed(6)}, Lon ${this.lockPosition.lon.toFixed(6)}`;
            document.getElementById("lockStatus").className = "status success";
            this.log("Position locked at: " + JSON.stringify(this.lockPosition));
            if (this.map) {
              this.map.setView([this.lockPosition.lat, this.lockPosition.lon], 15);
              this.map.invalidateSize();
              this.log("Map centered on locked position");
            }
          }
          this.updatePosition(position);
        },
        (error) => {
          document.getElementById("gpsStatus").textContent = `GPS Error: ${error.message}`;
          document.getElementById("gpsStatus").className = "status error";
          this.log("GPS Error: " + error.message, true);
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    } else {
      document.getElementById("gpsStatus").textContent = "GPS: Not supported";
      document.getElementById("gpsStatus").className = "status error";
      this.log("Geolocation not supported", true);
    }
  },

  updatePosition: function(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    this.lastPosition = { lat, lon, accuracy: position.coords.accuracy || 0, altitude: position.coords.altitude || 0 };
    this.currentSpeed = position.coords.speed || 0;

    if (this.userMarker && this.map) {
      this.userMarker.setLatLng([lat, lon]);
      this.map.panTo([lat, lon]);
      this.log(`Map updated: User marker moved to Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`);
    } else {
      this.log("Error: userMarker or map not initialized", true);
    }

    if (this.isActive && this.lockPosition && this.lockMarker && this.line) {
      this.lockMarker.setLatLng([this.lockPosition.lat, this.lockPosition.lon]);
      this.line.setLatLngs([[lat, lon], [this.lockPosition.lat, this.lockPosition.lon]]);
      this.log(`Map updated: Lock marker at Lat: ${this.lockPosition.lat.toFixed(6)}, Lon: ${this.lockPosition.lon.toFixed(6)}, polyline drawn`);
    }

    if (this.isRideActive) {
      this.movementHistory.push({ lat, lon, speed: this.currentSpeed, time: Date.now(), elev: position.coords.altitude || 0 });
      if (this.movementHistory.length > 1) {
        const last = this.movementHistory[this.movementHistory.length - 2];
        const dist = this.calculateDistance(last.lat, last.lon, lat, lon);
        this.todayDistance += dist;
        this.weekDistance += dist;
        this.monthDistance += dist;
        this.totalDistance += dist;
        if (position.coords.altitude && last.elev) {
          const elevDiff = position.coords.altitude - last.elev;
          if (elevDiff > 0) this.elevationGain += elevDiff;
        }
      }
      this.maxSpeed = Math.max(this.maxSpeed, this.currentSpeed * 3.6);
      this.checkAcceleration();
    }

    if (this.isActive && this.lockPosition) {
      const distance = this.calculateDistance(lat, lon, this.lockPosition.lat, this.lockPosition.lon);
      document.getElementById("distance").textContent = distance.toFixed(1);
      document.getElementById("accuracy").textContent = position.coords.accuracy.toFixed(1);
      const bearing = this.calculateBearing(lat, lon, this.lockPosition.lat, this.lockPosition.lon);
      this.updateDirectionArrow(bearing);
      document.getElementById("directionStatus").textContent = `Direction: ${bearing.toFixed(1)}°`;
      if (!this.isMuted) {
        const tempo = this.calculateTempo(distance);
        this.currentTempo = tempo;
        document.getElementById("bleepRate").textContent = (60000 / tempo).toFixed(0);
        this.playBleep();
      }
      if (distance < 5 && !this.reachedPointDisplayed) {
        document.getElementById("reachedMessage").style.display = "block";
        this.reachedPointDisplayed = true;
      }
    }

    this.updateWheelAnimation();
    this.checkAutoLock();
    this.updateUI();

    if (this.map) {
      this.map.invalidateSize();
    }
  },

  stop: function() {
    if (this.isActive) {
      this.isActive = false;
      this.lockPosition = null;
      this.lastPosition = null;
      this.reachedPointDisplayed = false;
      document.getElementById("reachedMessage").style.display = "none";
      document.getElementById("lockStatus").textContent = "Lock Status: Not locked";
      document.getElementById("lockStatus").className = "status";
      document.getElementById("stopGpsLockBtn").disabled = true;
      document.getElementById("muteBtn").disabled = true;
      clearTimeout(this.bleepTimer);
      this.updateGpsStatus("GPS lock stopped");
      this.log("GPS lock stopped");
      if (this.line) this.line.setLatLngs([]);
      if (this.lockMarker) this.lockMarker.setLatLng([0, 0]);
      if (this.userMarker) this.userMarker.setLatLng([0, 0]);
      if (this.map) {
        this.map.setView([0, 0], 2);
        this.map.invalidateSize();
        this.log("Map reset after stopping GPS lock");
      }
      if (this.watchId) {
        navigator.geolocation.clearWatch(this.watchId);
        this.watchId = null;
        this.log("Geolocation watch cleared");
      }
    }
  },

  updateDirectionArrow: function(bearing) {
    const arrow = document.getElementById("directionArrow");
    if (arrow) {
      arrow.style.transform = `translate(-50%, -50%) rotate(${bearing}deg)`;
    }
  },

  updateWheelAnimation: function() {
    const wheel = document.querySelector('.spinning-wheel');
    if (wheel) {
      const speed = this.currentSpeed * 3.6;
      const rotationSpeed = Math.min(speed / 10, 5);
      wheel.style.animationDuration = rotationSpeed > 0 ? `${1 / rotationSpeed}s` : '3s';
    }
  },

  toggleAutoLock: function() {
    this.autoLockEnabled = !this.autoLockEnabled;
    document.getElementById("autoLockBtn").classList.toggle('primary-btn', this.autoLockEnabled);
    document.getElementById("autoLockBtn").classList.toggle('secondary-btn', !this.autoLockEnabled);
    document.getElementById("autoLockSettings").style.display = this.autoLockEnabled ? 'block' : 'none';
    this.log(`Auto-lock ${this.autoLockEnabled ? 'enabled' : 'disabled'}`);
    if (!this.autoLockEnabled) {
      clearTimeout(this.autoLockDebounce);
      this.isStationary = false;
      this.lastStationaryTime = null;
      this.lastStationaryPosition = null;
    }
  },

  checkAutoLock: function() {
    if (this.autoLockEnabled && this.currentSpeed * 3.6 < this.speedThreshold) {
      if (!this.isStationary) {
        this.isStationary = true;
        this.lastStationaryTime = Date.now();
        this.lastStationaryPosition = this.lastPosition;
      } else {
        const stationaryTime = parseInt(document.getElementById("stationaryTime").value) * 1000;
        if (Date.now() - this.lastStationaryTime >= stationaryTime) {
          this.lockPosition = this.lastStationaryPosition;
          document.getElementById("lockStatus").textContent = `Lock Status: Auto-locked at Lat ${this.lockPosition.lat.toFixed(6)}, Lon ${this.lockPosition.lon.toFixed(6)}`;
          document.getElementById("lockStatus").className = "status success";
          document.getElementById("stopGpsLockBtn").disabled = false;
          this.isActive = true;
          this.log("Auto-locked position: " + JSON.stringify(this.lockPosition));
          if (this.map) {
            this.map.setView([this.lockPosition.lat, this.lockPosition.lon], 15);
            this.map.invalidateSize();
          }
        }
      }
    } else {
      this.isStationary = false;
      this.lastStationaryTime = null;
      this.lastStationaryPosition = null;
    }
  },

  toggleMute: function() {
    this.isMuted = !this.isMuted;
    document.getElementById("muteBtn").textContent = this.isMuted ? "Unmute Sound" : "Mute Sound";
    document.getElementById("muteBtn").classList.toggle('muted', this.isMuted);
    if (this.isMuted) {
      clearTimeout(this.bleepTimer);
      this.log("Sound muted");
    } else {
      this.playBleep();
      this.log("Sound unmuted");
    }
  },

  updateGpsStatus: function(status) {
    document.getElementById("gpsStatus").textContent = `GPS: ${status}`;
    document.getElementById("gpsStatus").className = "status";
  },

  initDeviceOrientation: function() {
    window.addEventListener('deviceorientation', (event) => {
      if (this.isCalibrating) {
        this.calibrationSamples.push(event.beta);
        if (this.calibrationSamples.length >= 10) {
          this.leanOffset = this.calibrationSamples.reduce((a, b) => a + b, 0) / this.calibrationSamples.length;
          this.isCalibrating = false;
          document.getElementById("calibrateStatus").textContent = "Sensors calibrated";
          document.getElementById("calibrateStatus").className = "status success";
          this.log("Sensors calibrated with offset: " + this.leanOffset);
          this.calibrationSamples = [];
          document.getElementById("autoLockBtn").disabled = false;
        }
      } else {
        this.currentLeanAngle = Math.abs(event.beta - this.leanOffset);
        this.updateLeanIndicator();
        this.checkCornering();
        this.checkCrash(event.beta);
      }
    });
  },

  calibrateSensors: function() {
    this.isCalibrating = true;
    this.calibrationSamples = [];
    document.getElementById("calibrateStatus").textContent = "Calibrating... please hold device steady";
    document.getElementById("calibrateStatus").className = "status warning";
    this.log("Sensor calibration started");
  },

  updateLeanIndicator: function() {
    const leanBike = document.getElementById("leanBike");
    const leanValue = document.getElementById("leanValue");
    if (leanBike && leanValue) {
      const maxLean = 45;
      const normalizedLean = Math.min(Math.max(this.currentLeanAngle, -maxLean), maxLean);
      const translateX = (normalizedLean / maxLean) * 80;
      leanBike.style.transform = `translateX(${translateX}px)`;
      leanValue.textContent = `${this.currentLeanAngle.toFixed(1)}°`;
      document.getElementById("leanAngle").textContent = `${this.currentLeanAngle.toFixed(1)}°`;
      this.maxLeanAngle = Math.max(this.maxLeanAngle, this.currentLeanAngle);
    }
  },

  checkCornering: function() {
    if (this.currentLeanAngle > 10 && this.currentSpeed > 2) {
      const gForce = (this.currentSpeed * this.currentSpeed) / (9.81 * Math.tan(this.currentLeanAngle * Math.PI / 180));
      this.currentCornerG = Math.min(gForce, 2);
      document.getElementById("currentCornerG").textContent = `${this.currentCornerG.toFixed(2)} g`;
      this.maxCornerG = Math.max(this.maxCornerG, this.currentCornerG);
      document.getElementById("maxCornerG").textContent = `${this.maxCornerG.toFixed(2)} g`;
      this.maxCornerSpeed = Math.max(this.maxCornerSpeed, this.currentSpeed * 3.6);
      document.getElementById("maxCornerSpeed").textContent = `${this.maxCornerSpeed.toFixed(1)} km/h`;

      if (this.corners.length === 0 || this.corners[this.corners.length - 1].exitTime) {
        this.corners.push({
          entrySpeed: this.currentSpeed * 3.6,
          maxG: this.currentCornerG,
          maxLean: this.currentLeanAngle,
          startTime: Date.now()
        });
        this.cornerEntrySpeeds.push(this.currentSpeed * 3.6);
      }
      this.updateCornerChart();
    } else if (this.corners.length > 0 && !this.corners[this.corners.length - 1].exitTime) {
      this.corners[this.corners.length - 1].exitTime = Date.now();
      this.corners[this.corners.length - 1].exitSpeed = this.currentSpeed * 3.6;
      this.cornerExitSpeeds.push(this.currentSpeed * 3.6);
      this.updateCornerList();
    }
  },

  updateCornerChart: function() {
    this.cornerChart.data.labels = this.corners.map((_, i) => `Corner ${i + 1}`);
    this.cornerChart.data.datasets[0].data = this.corners.map(c => c.maxG);
    this.cornerChart.update();
  },

  updateCornerList: function() {
    const cornerList = document.getElementById("cornerList");
    cornerList.innerHTML = this.corners.map((c, i) => 
      `Corner ${i + 1}: Max G ${c.maxG.toFixed(2)} g, Lean ${c.maxLean.toFixed(1)}°, Entry ${c.entrySpeed.toFixed(1)} km/h, Exit ${c.exitSpeed ? c.exitSpeed.toFixed(1) : '--'} km/h`
    ).join('<br>');
    const avgLean = this.corners.reduce((sum, c) => sum + c.maxLean, 0) / (this.corners.length || 1);
    document.getElementById("avgCornerLean").textContent = `${avgLean.toFixed(1)}°`;
    const avgEntrySpeed = this.cornerEntrySpeeds.reduce((sum, s) => sum + s, 0) / (this.cornerEntrySpeeds.length || 1);
    document.getElementById("avgCornerEntrySpeed").textContent = `${avgEntrySpeed.toFixed(1)} km/h`;
  },

  checkCrash: function(beta) {
    if (Math.abs(beta - this.leanOffset) > 70) {
      if (!this.crashStartTime) {
        this.crashStartTime = Date.now();
      } else if (Date.now() - this.crashStartTime > 5000) {
        this.crashDetected = true;
        document.getElementById("crashStatus").textContent = "Crash Detected!";
        document.getElementById("crashStatus").className = "status error";
        this.log("Crash detected!");
        if (this.emergencyContacts.length > 0) {
          this.sendEmergencyAlert(`Crash detected! Location: Lat ${this.lastPosition?.lat.toFixed(6)}, Lon ${this.lastPosition?.lon.toFixed(6)}`);
        }
      }
    } else {
      this.crashStartTime = null;
      if (this.crashDetected) {
        this.crashDetected = false;
        document.getElementById("crashStatus").textContent = "Crash Detection: Inactive";
        document.getElementById("crashStatus").className = "status";
        this.log("Crash detection reset");
      }
    }
  },

  checkAcceleration: function() {
    if (!this.accelerationStartTime && this.currentSpeed * 3.6 < 5) {
      this.accelerationStartTime = Date.now();
      this.accelerationStartSpeed = this.currentSpeed * 3.6;
    } else if (this.accelerationStartTime && this.currentSpeed * 3.6 >= this.accelTarget) {
      const timeTaken = (Date.now() - this.accelerationStartTime) / 1000;
      this.accelerationTimes.push(timeTaken);
      document.getElementById("accelerationTime").textContent = `${timeTaken.toFixed(2)} s`;
      document.getElementById("statsAcceleration").textContent = `${timeTaken.toFixed(2)} s`;
      this.accelerationStartTime = null;
      this.log(`0-${this.accelTarget} km/h in ${timeTaken.toFixed(2)} s`);
    }
  },

  startRide: function() {
    this.isRideActive = true;
    this.rideStartTime = Date.now();
    this.movementHistory = [];
    this.elevationHistory = [];
    this.corners = [];
    this.cornerEntrySpeeds = [];
    this.cornerExitSpeeds = [];
    this.maxSpeed = 0;
    this.elevationGain = 0;
    this.maxCornerG = 0;
    this.maxCornerSpeed = 0;
    document.getElementById("startRideBtn").disabled = true;
    document.getElementById("stopRideBtn").disabled = false;
    this.log("Ride started");
    if (!this.isActive) {
      this.lockCurrentPosition();
    }
  },

  stopRide: function() {
    this.isRideActive = false;
    document.getElementById("startRideBtn").disabled = false;
    document.getElementById("stopRideBtn").disabled = true;
    this.log("Ride stopped");
    const rideData = {
      startTime: this.rideStartTime,
      endTime: Date.now(),
      distance: this.todayDistance,
      maxSpeed: this.maxSpeed,
      elevationGain: this.elevationGain,
      avgSpeed: this.movementHistory.length > 0 ? 
        (this.movementHistory.reduce((sum, m) => sum + m.speed * 3.6, 0) / this.movementHistory.length).toFixed(1) : 0,
      corners: this.corners.length,
      maxCornerG: this.maxCornerG,
      maxCornerSpeed: this.maxCornerSpeed
    };
    this.rideHistory.push(rideData);
    this.saveData();
    this.updateRideHistory();
  },

  resetMetrics: function() {
    this.todayDistance = 0;
    this.weekDistance = 0;
    this.monthDistance = 0;
    this.totalDistance = 0;
    this.maxSpeed = 0;
    this.elevationGain = 0;
    this.maxCornerG = 0;
    this.maxCornerSpeed = 0;
    this.corners = [];
    this.cornerEntrySpeeds = [];
    this.cornerExitSpeeds = [];
    this.rideHistory = [];
    this.movementHistory = [];
    this.elevationHistory = [];
    this.updateUI();
    this.updateCornerChart();
    this.updateCornerList();
    this.updateRideHistory();
    this.saveData();
    this.log("Metrics reset");
  },

  exportMetrics: function() {
    const data = {
      totalDistance: this.totalDistance,
      weekDistance: this.weekDistance,
      monthDistance: this.monthDistance,
      rideHistory: this.rideHistory,
      corners: this.corners,
      elevationHistory: this.elevationHistory
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ride_data_${new Date().toISOString()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    this.log("Metrics exported");
  },

  updateUI: function() {
    document.getElementById("currentSpeed").textContent = `${(this.currentSpeed * 3.6).toFixed(1)} km/h`;
    document.getElementById("maxSpeed").textContent = `${this.maxSpeed.toFixed(1)} km/h`;
    document.getElementById("todayDistance").textContent = `${this.todayDistance.toFixed(2)} km`;
    document.getElementById("elevationGain").textContent = `${this.elevationGain.toFixed(1)} m`;
    document.getElementById("statsToday").textContent = `${this.todayDistance.toFixed(2)} km`;
    document.getElementById("statsWeek").textContent = `${this.weekDistance.toFixed(2)} km`;
    document.getElementById("statsMonth").textContent = `${this.monthDistance.toFixed(2)} km`;
    document.getElementById("statsTotal").textContent = `${this.totalDistance.toFixed(2)} km`;
    document.getElementById("statsCurrentSpeed").textContent = `${(this.currentSpeed * 3.6).toFixed(1)} km/h`;
    document.getElementById("statsMaxSpeed").textContent = `${this.maxSpeed.toFixed(1)} km/h`;
    const avgSpeed = this.movementHistory.length > 0 ? 
      (this.movementHistory.reduce((sum, m) => sum + m.speed * 3.6, 0) / this.movementHistory.length).toFixed(1) : 0;
    document.getElementById("statsAvgSpeed").textContent = `${avgSpeed} km/h`;
    this.updateElevationProfile();
  },

  updateElevationProfile: function() {
    if (this.canvas && this.elevationHistory.length > 0) {
      const ctx = this.canvas.getContext('2d');
      ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      const maxElev = Math.max(...this.elevationHistory, 0);
      const minElev = Math.min(...this.elevationHistory, 0);
      const range = maxElev - minElev || 1;
      ctx.beginPath();
      ctx.moveTo(0, this.canvas.height);
      this.elevationHistory.forEach((elev, i) => {
        const x = (i / (this.elevationHistory.length - 1)) * this.canvas.width;
        const y = this.canvas.height - ((elev - minElev) / range) * this.canvas.height;
        ctx.lineTo(x, y);
      });
      ctx.strokeStyle = '#00ccff';
      ctx.stroke();
      document.getElementById("totalElevationGain").textContent = `${this.elevationGain.toFixed(1)} m`;
      document.getElementById("maxElevation").textContent = `${maxElev.toFixed(1)} m`;
      document.getElementById("minElevation").textContent = `${minElev.toFixed(1)} m`;
    }
  },

  sendEmergencyAlert: function(message = null) {
    const msg = message || `${document.getElementById('emergencyMessage').value} Lat: ${this.lastPosition?.lat.toFixed(6)}, Lon: ${this.lastPosition?.lon.toFixed(6)}`;
    const phoneContacts = document.getElementById('emergencyContacts').value.split(',').map(c => c.trim()).filter(c => c);
    const messengerContacts = document.getElementById('messengerContacts').value.split(',').map(c => c.trim()).filter(c => c);
    
    phoneContacts.forEach(contact => {
      if (contact.startsWith('+')) {
        this.log(`Sending SMS alert to ${contact}: ${msg}`);
        window.open(`sms:${contact}?body=${encodeURIComponent(msg)}`, '_blank');
      }
    });
    
    messengerContacts.forEach(contact => {
      const link = `https://m.me/${contact}?text=${encodeURIComponent(msg)}`;
      this.log(`Opening Messenger for ${contact}: ${link}`);
      window.open(link, '_blank');
    });
    
    if (phoneContacts.length === 0 && messengerContacts.length === 0) {
      this.log("No emergency contacts configured", true);
      alert("Please add phone numbers or Messenger contacts in the Emergency tab.");
    } else {
      this.log("Emergency alert sent to configured contacts");
    }
  },

sendEmergencyAlert: function(message = null) {
  const msg = message || `${document.getElementById('emergencyMessage').value} Lat: ${this.lastPosition?.lat.toFixed(6)}, Lon: ${this.lastPosition?.lon.toFixed(6)}`;
  
  this.emergencyContacts.forEach(contact => {
    // Copy message to clipboard for easy pasting
    navigator.clipboard.writeText(msg).then(() => {
      this.log(`Message copied to clipboard for ${contact}`);
    }).catch(err => {
      this.log(`Could not copy to clipboard: ${err}`, true);
    });
    
    // Use SMS - much more reliable
    const smsUrl = `sms:${contact}?body=${encodeURIComponent(msg)}`;
    window.location.href = smsUrl;
    this.log(`Opening SMS to ${contact}: ${msg}`);
  });
  this.log("Emergency SMS messages opened");
},

updateEmergencyContacts: function() {
  const list = document.getElementById("emergencyContactList");
  list.innerHTML = this.emergencyContacts.map(contact => `
    <div class="contact-item">
      <span>${contact}</span>
      <button onclick="MotoFindBack.sendEmergencyAlert('Emergency to ${contact}: ${document.getElementById('emergencyMessage').value}')">SMS</button>
    </div>
  `).join('');
},

  showMaintenanceForm: function() {
    document.getElementById("newMaintenanceName").style.display = "block";
    document.getElementById("newMaintenanceInterval").style.display = "block";
    document.getElementById("saveMaintenanceBtn").style.display = "block";
  },

  saveMaintenanceItem: function() {
    const name = document.getElementById("newMaintenanceName").value;
    const interval = parseInt(document.getElementById("newMaintenanceInterval").value);
    if (name && interval) {
      this.maintenanceItems.push({ name, interval, progress: 0 });
      this.updateMaintenanceList();
      document.getElementById("newMaintenanceName").value = "";
      document.getElementById("newMaintenanceInterval").value = "";
      this.log(`Maintenance item added: ${name}`);
    }
  },

  resetMaintenance: function() {
    this.maintenanceItems = [];
    this.updateMaintenanceList();
    this.log("Maintenance items reset");
  },

  updateMaintenanceList: function() {
    const list = document.getElementById("maintenanceList");
    list.innerHTML = this.maintenanceItems.map(item => `
      <div class="maintenance-item">
        <div>${item.name}</div>
        <div class="maintenance-progress">
          <div class="maintenance-progress-bar" style="width: ${(item.progress / item.interval) * 100}%"></div>
        </div>
        <div>${item.progress}/${item.interval} km</div>
      </div>
    `).join('') || `
      <div class="maintenance-item">
        <div>Oil Change</div>
        <div class="maintenance-progress"><div class="maintenance-progress-bar" style="width: 30%"></div></div>
        <div>2000/5000 km</div>
      </div>
      <div class="maintenance-item">
        <div>Tire Pressure</div>
        <div class="maintenance-progress"><div class="maintenance-progress-bar" style="width: 70%"></div></div>
        <div>Check weekly</div>
      </div>
      <div class="maintenance-item">
        <div>Chain Lubrication</div>
        <div class="maintenance-progress"><div class="maintenance-progress-bar" style="width: 50%"></div></div>
        <div>500/1000 km</div>
      </div>
    `;
  },

  updateRideHistory: function() {
    const history = document.getElementById("rideHistory");
    history.innerHTML = this.rideHistory.map(ride => `
      <div>Ride on ${new Date(ride.startTime).toLocaleString()}: ${ride.distance.toFixed(1)} km, Max Speed: ${ride.maxSpeed.toFixed(1)} km/h, Avg Speed: ${ride.avgSpeed.toFixed(1)} km/h, 0-${this.accelTarget} km/h: ${ride.acceleration.toFixed(2)} s, Corners: ${ride.corners}, Elevation Gain: ${ride.elevationGain.toFixed(0)} m</div>
    `).join('') || "No ride history yet.";
  },

  loadData: function() {
    try {
      const savedHistory = localStorage.getItem('MotoFindBackRideHistory');
      if (savedHistory) {
        this.rideHistory = JSON.parse(savedHistory);
        this.updateRideHistory();
        this.log("Ride history loaded from localStorage");
      } else {
        this.log("No saved ride history found");
      }
    } catch (e) {
      this.log(`Error loading ride history: ${e.message}`, true);
    }
  },

  saveData: function() {
    try {
      localStorage.setItem('MotoFindBackRideHistory', JSON.stringify(this.rideHistory));
      this.log("Ride history saved to localStorage");
    } catch (e) {
      this.log(`Error saving ride history: ${e.message}`, true);
    }
  }
};

MotoFindBack.init();
</script>
  </body>
</html>
