<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spin - Motorcycle GPS Locator</title>
  <!-- Leaflet Map CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary-color: #ff6600;
      --secondary-color: #333;
      --accent-color: #00ccff;
      --text-color: #fff;
      --warning-color: #ffcc00;
      --error-color: #ff3333;
      --success-color: #00cc66;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: var(--text-color);
      text-align: center;
      padding: 1em;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
      position: relative;
    }
    
    .app-title {
      font-size: 2.2em;
      margin: 0;
      color: var(--primary-color);
      text-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
    }
    
    .wheel-container {
      position: relative;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .spinning-wheel {
      width: 50px;
      height: 50px;
      position: relative;
      animation: wheel-spin 3s linear infinite;
    }
    
    .wheel-outer {
      fill: none;
      stroke: var(--primary-color);
      stroke-width: 3;
      stroke-dasharray: 5;
      animation: wheel-dash 1s linear infinite;
    }
    
    .wheel-inner {
      fill: none;
      stroke: var(--accent-color);
      stroke-width: 2;
    }
    
    .wheel-spoke {
      stroke: var(--accent-color);
      stroke-width: 2;
      transform-origin: center;
    }
    
    .spoke-1 { animation: spoke-spin 4s linear infinite; }
    .spoke-2 { animation: spoke-spin 3s linear infinite reverse; }
    .spoke-3 { animation: spoke-spin 5s linear infinite; }
    
    @keyframes wheel-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes wheel-dash {
      to {
        stroke-dashoffset: -10;
      }
    }
    
    @keyframes spoke-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .wheel-pulse {
      fill: var(--primary-color);
      animation: wheel-pulse 2s ease-in-out infinite;
    }
    
    @keyframes wheel-pulse {
      0%, 100% { opacity: 0.7; transform: scale(0.95); }
      50% { opacity: 1; transform: scale(1); }
    }
    
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .dashboard-item {
      background: rgba(40, 40, 40, 0.7);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #444;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .dashboard-value {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--accent-color);
      margin: 5px 0;
    }
    
    .dashboard-label {
      font-size: 0.9em;
      color: #aaa;
    }
    
    .panel {
      background: rgba(30, 30, 30, 0.8);
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .control-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    
    input, button, select {
      margin: 0.5em;
      padding: 0.7em 1em;
      font-size: 1em;
      background: #333;
      color: var(--text-color);
      border: 1px solid #555;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    button {
      cursor: pointer;
      background: linear-gradient(to bottom, #444, #333);
      font-weight: bold;
    }
    
    button:hover:not(:disabled) {
      background: linear-gradient(to bottom, #555, #444);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .primary-btn {
      background: linear-gradient(to bottom, var(--primary-color), #e55d00);
      color: #fff;
      border: 1px solid #ff8533;
    }
    
    .secondary-btn {
      background: linear-gradient(to bottom, #555, #444);
      color: #fff;
    }
    
    .warning-btn {
      background: linear-gradient(to bottom, var(--warning-color), #e6b800);
      color: #000;
    }
    
    .emergency-btn {
      background: linear-gradient(to bottom, var(--error-color), #cc0000);
      color: #fff;
      animation: pulse-emergency 2s infinite;
    }
    
    @keyframes pulse-emergency {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #debug {
      text-align: left;
      margin: 20px auto;
      padding: 10px;
      border: 1px dashed #555;
      color: #aaa;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9em;
      background: rgba(20, 20, 20, 0.8);
      border-radius: 5px;
    }
    
    .status {
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .success {
      background: rgba(0, 204, 102, 0.2);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }
    
    .error {
      background: rgba(255, 51, 51, 0.2);
      border: 1px solid var(--error-color);
      color: var(--error-color);
    }
    
    .warning {
      background: rgba(255, 204, 0, 0.2);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }
    
    .speed-indicator {
      font-size: 1em;
      margin-top: 5px;
      color: var(--accent-color);
      font-weight: bold;
    }
    
    .auto-lock-settings {
      margin-top: 10px;
      padding: 10px;
      border-top: 1px dashed #555;
    }
    
    .slider-label {
      display: inline-flex;
      align-items: center;
      margin-left: 5px;
      color: var(--accent-color);
    }
    
    .direction-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 10px auto;
    }
    
    #directionArrow {
      width: 0; 
      height: 0; 
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 40px solid var(--primary-color);
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 50% 0;
      transform: translate(-50%, -50%) rotate(0deg);
      transition: transform 0.3s ease;
    }
    
    .direction-circle {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 1px dashed var(--accent-color);
      border-radius: 50%;
      top: 0;
      left: 0;
      box-sizing: border-box;
    }
    
    .direction-status {
      font-size: 0.9em;
      margin-top: 5px;
    }
    
    #map {
      height: 250px;
      width: 100%;
      background: #222;
      border: 1px solid #555;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .user-marker, .lock-marker {
      font-size: 20px;
      text-shadow: 0 0 3px #000;
    }
    
    .leaflet-control-attribution {
      background: rgba(0, 0, 0, 0.7) !important;
      color: #aaa !important;
      font-family: monospace;
      font-size: 0.8em;
    }
    
    .reached-message {
      color: var(--success-color);
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    
    button.muted {
      background: #f00 !important;
      color: #fff !important;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .lean-container {
      position: relative;
      width: 200px;
      height: 100px;
      margin: 10px auto;
      background: rgba(50, 50, 50, 0.7);
      border-radius: 100px 100px 0 0;
      overflow: hidden;
    }
    
    .lean-bike {
      position: absolute;
      width: 40px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 10px 10px 0 0;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      transition: transform 0.1s ease; /* Faster transition for lean angle */
    }
    
    .lean-scale {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-around;
    }
    
    .lean-mark {
      width: 1px;
      height: 10px;
      background: #666;
      position: relative;
      top: 10px;
    }
    
    .lean-mark:nth-child(6) {
      height: 20px;
      background: var(--accent-color);
    }
    
    .lean-value {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      color: var(--accent-color);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      background: rgba(50, 50, 50, 0.7);
    }
    
    .tab.active {
      background: rgba(30, 30, 30, 0.9);
      border-color: #444;
      border-bottom: 1px solid rgba(30, 30, 30, 0.9);
      margin-bottom: -1px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .maintenance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: rgba(50, 50, 50, 0.5);
      border-radius: 5px;
    }
    
    .maintenance-progress {
      height: 10px;
      background: #333;
      border-radius: 5px;
      flex-grow: 1;
      margin: 0 10px;
      overflow: hidden;
    }
    
    .maintenance-progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--success-color), var(--warning-color), var(--error-color));
      border-radius: 5px;
    }
    
    .emergency-panel {
      background: rgba(204, 0, 0, 0.2);
      border: 1px solid var(--error-color);
    }
    
    .emergency-contacts {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
    }
    
    .contact-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      background: rgba(50, 50, 50, 0.7);
      border-radius: 5px;
      min-width: 120px;
    }
    
    .collapsible {
      cursor: pointer;
      padding: 10px;
      border: none;
      text-align: center;
      outline: none;
      font-size: 1em;
      color: var(--primary-color);
      background: transparent;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .collapsible:after {
      content: 'â–¼';
      font-size: 0.8em;
      margin-left: 5px;
      transition: transform 0.2s;
    }
    
    .collapsible.active:after {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      padding: 0 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }
    
    .session-btn {
  background: linear-gradient(to bottom, #00cc66, #00aa55);
  color: #fff;
  border: 1px solid #00ff88;
}

.session-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 15px 0;
}

.acceleration-settings {
  margin-top: 10px;
  padding: 10px;
  border-top: 1px dashed #555;
}

@media (max-width: 768px) {
  .session-controls {
    flex-direction: column;
    align-items: center;
  }
}
    
    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      .app-header {
        flex-direction: column;
      }
      
      .control-group {
        flex-direction: column;
        align-items: center;
      }
      
      .wheel-container {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="app-header">
    <h1 class="app-title">Spin</h1>
    <div class="wheel-container">
      <svg class="spinning-wheel" viewBox="0 0 100 100">
        <circle class="wheel-outer" cx="50" cy="50" r="40" />
        <circle class="wheel-inner" cx="50" cy="50" r="25" />
        <line class="wheel-spoke spoke-1" x1="50" y1="50" x2="75" y2="50" />
        <line class="wheel-spoke spoke-2" x1="50" y1="50" x2="50" y2="25" />
        <line class="wheel-spoke spoke-3" x1="50" y1="50" x2="30" y2="70" />
        <circle class="wheel-pulse" cx="50" cy="50" r="8" />
      </svg>
    </div>
  </div>
  
    <div class="session-controls">
    <button id="startSessionBtn" class="session-btn">Start Bike Session</button>
    <button id="endSessionBtn" class="secondary-btn" disabled>End Session</button>
    <button id="saveSessionBtn" class="secondary-btn">Save Session</button>
  </div>

  <div class="dashboard">
    <div class="dashboard-item">
      <div class="dashboard-label">Current Speed</div>
      <div class="dashboard-value" id="currentSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Max Speed</div>
      <div class="dashboard-value" id="maxSpeed">-- km/h</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Average Speed</div>
      <div class="dashboard-value" id="avgSpeed">-- km/h</div>
    </div>
        <div class="dashboard-item">
      <div class="dashboard-label">Lean Angle</div>
      <div class="dashboard-value" id="leanAngle">--Â°</div>
    </div>
    <div class="dashboard-item">
      <div class="dashboard-label">Today's Distance</div>
      <div class="dashboard-value" id="todayDistance">-- km</div>
    </div>
 <div class="dashboard-item">
  <div class="dashboard-label" id="accelerationLabel">0-100 km/h</div>
  <div class="dashboard-value" id="accelerationTime">-- s</div>
</div>

  <div class="tabs">
    <div class="tab active" data-tab="navigation">Navigation</div>
    <div class="tab" data-tab="metrics">Ride Metrics</div>
    <div class="tab" data-tab="emergency">Emergency</div>
    <div class="tab" data-tab="maintenance">Maintenance</div>
  </div>

  <div class="tab-content active" id="navigation-tab">
    <div class="panel">
      <h2>GPS Navigation</h2>
      <p class="warning">TAP "TEST AUDIO & LOCK" FIRST!</p>

      <div class="control-group">
        <button id="testBtn" class="primary-btn">Test Audio & Lock</button>
        <button id="calibrateBtn" class="secondary-btn">Calibrate Sensors</button>
        <button id="autoLockBtn" class="secondary-btn" disabled>Auto-Lock Mode</button>
        <button id="muteBtn" class="secondary-btn" disabled>Mute Sound</button>
        <button id="stopBtn" class="secondary-btn" disabled>Stop</button>
      </div>
      
      <div id="autoLockSettings" style="display: none;">
        <div class="control-group">
          <div class="control-item">
            <label for="stationaryTime">Stationary Confirmation Time</label>
            <div>
              <input type="range" id="stationaryTime" value="30" min="5" max="60" />
              <span id="stationaryTimeValue" class="slider-label">30 sec</span>
            </div>
          </div>
          <div class="control-item">
            <label for="speedThreshold">Speed Threshold (km/h)</label>
            <div>
              <input type="range" id="speedThreshold" value="10" min="5" max="20" />
              <span id="speedThresholdValue" class="slider-label">10 km/h</span>
            </div>
          </div>
        </div>
      </div>
      
      <div id="calibrateStatus" class="status">Sensors not calibrated</div>
      <div id="lockStatus" class="status">Lock Status: Not locked</div>
      <div id="audioStatus" class="status">Audio: Not initialized</div>
      <div id="gpsStatus" class="status">GPS: Ready</div>
      <div id="reachedMessage" class="reached-message" style="display: none;">You have reached GPS locked point!</div>
    </div>

    <div class="panel">
      <h2>Position Map</h2>
      <div id="map"></div>
    </div>

    <div class="panel">
      <button class="collapsible">Direction Indicator â–¼</button>
      <div class="collapsible-content">
        <div class="direction-container">
          <div id="directionArrow"></div>
          <div class="direction-circle"></div>
        </div>
        <div id="directionStatus" class="direction-status">Direction: --</div>
      </div>

      <button class="collapsible">Sonar Parameters â–¼</button>
      <div class="collapsible-content">
        <div class="control-group">
          <div class="control-item">
            <label for="freqInput">Bleep Freq (Hz)</label><br>
            <input type="number" id="freqInput" value="800" min="20" max="20000" />
          </div>
          <div class="control-item">
            <label for="maxDistInput">Max Distance (m)</label><br>
            <input type="range" id="maxDistInput" value="50" min="1" max="500" />
            <span id="maxDistValue">50</span> m
          </div>
        </div>
      </div>

      <button class="collapsible">Data Output â–¼</button>
      <div class="collapsible-content">
        <div class="control-group">
          <div class="control-item">
            <label>Distance</label><br>
            <span id="distance">--</span> m
          </div>
          <div class="control-item">
            <label>Accuracy</label><br>
            <span id="accuracy">--</span> m
          </div>
          <div class="control-item">
            <label>BPM</label><br>
            <span id="bleepRate">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="metrics-tab">
    <div class="panel">
      <h2>Ride Metrics</h2>
      
          <div class="acceleration-settings">
      <div class="control-group">
        <div class="control-item">
          <label for="accelerationTarget">Acceleration Target (km/h)</label><br>
          <input type="number" id="accelerationTarget" value="100" min="20" max="300" />
          <button id="setAccelerationTarget" class="secondary-btn">Set Target</button>
        </div>
      </div>
    </div>
      
      <div class="control-group">
        <button id="resetMetricsBtn" class="secondary-btn">Reset Metrics</button>
        <button id="exportMetricsBtn" class="secondary-btn">Export Data</button>
      </div>
      
      <div class="lean-container">
        <div class="lean-scale">
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
          <div class="lean-mark"></div>
        </div>
        <div class="lean-bike" id="leanBike"></div>
        <div class="lean-value" id="leanValue">0Â°</div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <h3>Distance Statistics</h3>
          <div>Today: <span id="statsToday">0 km</span></div>
          <div>This Week: <span id="statsWeek">0 km</span></div>
          <div>This Month: <span id="statsMonth">0 km</span></div>
          <div>Total: <span id="statsTotal">0 km</span></div>
          <div id="statsAccelerationLabel">0-100 km/h: <span id="statsAcceleration">-- s</span></div>
        </div>
        
        <div class="control-item">
          <h3>Speed Statistics</h3>
          <div>Current: <span id="statsCurrentSpeed">0 km/h</span></div>
          <div>Average: <span id="statsAvgSpeed">0 km/h</span></div>
          <div>Max: <span id="statsMaxSpeed">0 km/h</span></div>
          <div>0-100 km/h: <span id="statsAcceleration">-- s</span></div>
        </div>
      </div>
      
      <div class="control-item">
  <h3>Session History</h3>
  <div id="sessionHistory" style="max-height: 200px; overflow-y: auto; text-align: left; padding: 10px; background: rgba(40,40,40,0.7); border-radius: 5px;">
    No sessions recorded yet.
  </div>
</div>
      
      <div class="control-item">
        <h3>Ride History</h3>
        <div id="rideHistory" style="max-height: 200px; overflow-y: auto; text-align: left; padding: 10px; background: rgba(40,40,40,0.7); border-radius: 5px;">
          No ride history yet.
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="emergency-tab">
    <div class="panel emergency-panel">
      <h2>Emergency Features</h2>
      
      <div class="control-group">
        <button id="emergencyBtn" class="emergency-btn">EMERGENCY ALERT</button>
      </div>
      
      <div id="crashStatus" class="status">Crash Detection: Inactive</div>
      
      <div class="control-group">
        <div class="control-item">
          <label for="emergencyMessage">Emergency Message</label><br>
          <textarea id="emergencyMessage" rows="3" style="width: 100%;">I need help! My current location is: </textarea>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <label for="emergencyContacts">Emergency Contacts (comma separated)</label><br>
          <input type="text" id="emergencyContacts" value="" placeholder="+1234567890,+0987654321" style="width: 100%;" />
        </div>
      </div>
      
      <h3>Quick Contact</h3>
      <div class="emergency-contacts" id="emergencyContactList">
      </div>
      
      <div class="control-group">
        <button id="testEmergencyBtn" class="warning-btn">Test Emergency</button>
        <button id="addContactBtn" class="secondary-btn">Add Contact</button>
      </div>
    </div>
  </div>

  <div class="tab-content" id="maintenance-tab">
    <div class="panel">
      <h2>Maintenance Alerts</h2>
      
      <div class="control-group">
        <button id="addMaintenanceBtn" class="primary-btn">Add Maintenance Item</button>
        <button id="resetMaintenanceBtn" class="secondary-btn">Reset All</button>
      </div>
      
      <div id="maintenanceList">
        <div class="maintenance-item">
          <div>Oil Change</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 30%;"></div>
          </div>
          <div>2000/5000 km</div>
        </div>
        
        <div class="maintenance-item">
          <div>Tire Pressure</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 70%;"></div>
          </div>
          <div>Check weekly</div>
        </div>
        
        <div class="maintenance-item">
          <div>Chain Lubrication</div>
          <div class="maintenance-progress">
            <div class="maintenance-progress-bar" style="width: 50%;"></div>
          </div>
          <div>500/1000 km</div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <h3>Add New Maintenance Item</h3>
          <input type="text" id="newMaintenanceName" placeholder="Item name" />
          <input type="number" id="newMaintenanceInterval" placeholder="Interval (km)" />
          <button id="saveMaintenanceBtn" class="secondary-btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2 class="help-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
      Help Guide â–¼
    </h2>
    <div id="helpContent" style="display: none; text-align: left; padding: 10px;">
      <h1>Spin</h1>
      <h2>Purpose:</h2>
      Motorcycle-focused GPS navigation with ride metrics, emergency features, and maintenance tracking. The spinning wheel in the header rotates to reflect your current speed, spinning faster as you ride faster.

      <h2>Navigation Tab</h2>
      <strong>GPS Navigation:</strong> Lock your position and navigate back with audio cues.<br>
      <strong>Calibrate Sensors:</strong> Place phone on bike in riding position and tap to set baseline for lean angle and crash detection.<br>
      <strong>Auto-Lock Mode:</strong> Automatically locks position when motorcycle is stationary.<br>
      <strong>Direction Indicator:</strong> Visual compass pointing to locked position.<br>
      <strong>Sonar Parameters:</strong> Adjust audio feedback frequency and range.

      <h2>Metrics Tab</h2>
      <strong>Ride Metrics:</strong> Track speed, distance, acceleration, and lean angles with real-time updates.<br>
      <strong>Lean Angle Indicator:</strong> Visual display of motorcycle lean during corners, updated rapidly for responsiveness.<br>
      <strong>Distance Statistics:</strong> Daily, weekly, monthly, and total distance tracking.<br>
      <strong>Acceleration Timer:</strong> Measures 0-100 km/h acceleration.

      <h2>Emergency Tab</h2>
      <strong>Emergency Alert:</strong> Send your location to emergency contacts manually.<br>
      <strong>Crash Detection:</strong> Automatically sends location to contacts if bike is detected lying flat for 5 seconds.<br>
      <strong>Quick Contacts:</strong> Pre-set emergency contacts for quick access.<br>
      <strong>Custom Message:</strong> Edit the emergency message with your details.

      <h2>Maintenance Tab</h2>
      <strong>Maintenance Alerts:</strong> Track service intervals based on mileage.<br>
      <strong>Progress Indicators:</strong> Visual progress bars for each maintenance item.<br>
      <strong>Custom Items:</strong> Add your own maintenance tasks and intervals.

      <h2>Quick Start</h2>
      1. Mount phone securely and tap "Calibrate Sensors" to set lean angle and crash detection baseline.<br>
      2. Set emergency contacts in the Emergency tab.<br>
      3. Tap "Test Audio & Lock" to initialize the app.<br>
      4. Use the Navigation tab to lock your parking position.<br>
      5. Check the Metrics tab during your ride for performance data; watch the header wheel spin with your speed.<br>
      6. Add maintenance schedules in the Maintenance tab.

      <h2>Tips</h2>
      - For accurate lean angles and crash detection, mount your phone securely on the motorcycle and calibrate sensors.<br>
      - Set up emergency contacts before your first ride to enable crash detection alerts.<br>
      - Regular maintenance alerts help keep your motorcycle in top condition.<br>
      - Export your ride data to track your riding habits over time.
    </div>
  </div>

  <div id="debug"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
 const MotoFindBack = {
    audioCtx: null,
    watchId: null,
    bleepTimer: null,
    lockPosition: null,
    lastUpdateTime: Date.now(),
    lastBleedTime: 0,
    isAudioAllowed: false,
    isActive: false,
    movementHistory: [],
    currentTempo: 1000,
    autoLockEnabled: false,
    autoLockDebounce: null,
    currentSpeed: 0,
    reachedPointDisplayed: false,
    isMuted: false,
    isStationary: false,
    lastStationaryTime: null,
    lastStationaryPosition: null,
    speedThreshold: 10,
    maxSpeed: 0,
    totalDistance: 0,
    todayDistance: 0,
    weekDistance: 0,
    monthDistance: 0,
    rideStartTime: null,
    accelerationStartTime: null,
    accelerationStartSpeed: 0,
    accelerationTimes: [],
    maxLeanAngle: 0,
    currentLeanAngle: 0,
    maintenanceItems: [],
    emergencyContacts: [],
    rideHistory: [],
    isCalibrating: false,
    calibrationSamples: [],
    leanOffset: 0,
    crashDetected: false,
    crashStartTime: null,
    lastPosition: null,
    rotationSpeed: 0,
    map: null,
    userMarker: null,
    lockMarker: null,
    line: null,
    sessionActive: false,
    sessionStartTime: null,
    sessionDistance: 0,
    sessionSpeeds: [],
    accelerationTarget: 100,
    sessionHistory: [],
    sessionEndTime: null,

    init: async function() {
        this.initMap();
        this.setupEventListeners();
        this.setupTabs();
        this.setupCollapsibles();
        this.loadData();
        this.updateUI();
        this.log("MotoFindBack initialized");

        document.getElementById("maxDistInput").addEventListener("input", (e) => {
            document.getElementById("maxDistValue").textContent = e.target.value;
        });

        document.getElementById("stationaryTime").addEventListener("input", (e) => {
            document.getElementById("stationaryTimeValue").textContent = e.target.value + ' sec';
        });

        document.getElementById("speedThreshold").addEventListener("input", (e) => {
            this.speedThreshold = parseFloat(e.target.value);
            document.getElementById("speedThresholdValue").textContent = e.target.value + ' km/h';
        });

        this.initDeviceOrientation();
    },

    initMap: function() {
        this.map = L.map('map').setView([51.505, -0.09], 15);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(this.map);

        const userIcon = L.divIcon({
            className: 'user-marker',
            html: 'ðŸ“',
            iconSize: [24, 24]
        });

        const lockIcon = L.divIcon({
            className: 'lock-marker',
            html: 'ðŸ”’',
            iconSize: [24, 24]
        });

        this.userMarker = L.marker([0, 0], { icon: userIcon }).addTo(this.map);
        this.lockMarker = L.marker([0, 0], { icon: lockIcon }).addTo(this.map);
        this.line = L.polyline([], { color: '#ff6600', weight: 2 }).addTo(this.map);
    },

    setupTabs: function() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
    },

    setupCollapsibles: function() {
        const coll = document.getElementsByClassName("collapsible");
        for (let i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }
    },

    updateSessionHistory: function() {
        const historyElement = document.getElementById("sessionHistory");
        historyElement.innerHTML = "";
        
        if (this.sessionHistory.length === 0) {
            historyElement.innerHTML = "No sessions recorded yet.";
            return;
        }
        
        this.sessionHistory.slice().reverse().forEach((session, index) => {
            const sessionElement = document.createElement("div");
            sessionElement.style.padding = "5px";
            sessionElement.style.borderBottom = "1px solid #444";
            sessionElement.innerHTML = `
                <strong>Session ${this.sessionHistory.length - index}</strong><br>
                Date: ${new Date(session.startTime).toLocaleDateString()}<br>
                Duration: ${this.formatDuration(session.duration)}<br>
                Distance: ${session.distance.toFixed(2)} km<br>
                Max Speed: ${(session.maxSpeed * 3.6).toFixed(1)} km/h
            `;
            historyElement.appendChild(sessionElement);
        });
    },

    setupEventListeners: function() {
        // Session controls
        document.getElementById("startSessionBtn").addEventListener("click", () => {
            this.startSession();
        });

        document.getElementById("endSessionBtn").addEventListener("click", () => {
            this.endSession();
        });

        document.getElementById("saveSessionBtn").addEventListener("click", () => {
            this.saveSession();
        });

        document.getElementById("setAccelerationTarget").addEventListener("click", () => {
            this.setAccelerationTarget();
        });

        // Existing navigation controls
        document.getElementById("testBtn").addEventListener("click", () => {
            this.initAudio();
            this.playTestSound();
            if (this.isAudioAllowed) {
                this.lockCurrentPosition();
            }
        });

        document.getElementById("calibrateBtn").addEventListener("click", () => {
            this.calibrateSensors();
        });

        document.getElementById("autoLockBtn").addEventListener("click", () => {
            this.toggleAutoLock();
        });

        document.getElementById("muteBtn").addEventListener("click", () => {
            this.toggleMute();
        });

        document.getElementById("stopBtn").addEventListener("click", () => {
            this.stop();
        });

        document.getElementById("resetMetricsBtn").addEventListener("click", () => {
            this.resetMetrics();
        });

        document.getElementById("exportMetricsBtn").addEventListener("click", () => {
            this.exportMetrics();
        });

        document.getElementById("emergencyBtn").addEventListener("click", () => {
            this.sendEmergencyAlert();
        });

        document.getElementById("testEmergencyBtn").addEventListener("click", () => {
            this.testEmergency();
        });

        document.getElementById("addContactBtn").addEventListener("click", () => {
            this.addEmergencyContact();
        });

        document.getElementById("addMaintenanceBtn").addEventListener("click", () => {
            this.showMaintenanceForm();
        });

        document.getElementById("resetMaintenanceBtn").addEventListener("click", () => {
            this.resetMaintenance();
        });

        document.getElementById("saveMaintenanceBtn").addEventListener("click", () => {
            this.saveMaintenanceItem();
        });
    },

    initDeviceOrientation: function() {
        if (!window.DeviceOrientationEvent) {
            this.log("Device orientation not supported", true);
            document.getElementById('crashStatus').textContent = 'Crash Detection: Not supported';
            document.getElementById('crashStatus').className = 'status error';
            return;
        }

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(permissionState => {
                    if (permissionState === 'granted') {
                        this.startOrientationListening();
                    } else {
                        this.log("Orientation permission denied", true);
                    }
                })
                .catch(error => {
                    this.log("Orientation permission error: " + error, true);
                });
        } else {
            this.startOrientationListening();
        }
    },

    startOrientationListening: function() {
        window.addEventListener('deviceorientation', (event) => {
            if (this.isCalibrating) {
                this.calibrationSamples.push(event.gamma || 0);
                return;
            }
            if (event.gamma !== null) {
                this.currentLeanAngle = Math.round(Math.abs(event.gamma - this.leanOffset));
                this.updateLeanAngleDisplay();
                if (this.currentLeanAngle > this.maxLeanAngle) {
                    this.maxLeanAngle = this.currentLeanAngle;
                    document.getElementById('leanAngle').textContent = `${this.maxLeanAngle}Â°`;
                }
            }
            if (event.beta !== null && !this.crashDetected) {
                const betaAbs = Math.abs(event.beta);
                if (betaAbs > 70) {
                    if (!this.crashStartTime) {
                        this.crashStartTime = Date.now();
                        document.getElementById('crashStatus').textContent = 'Possible crash detected... Confirming';
                        document.getElementById('crashStatus').className = 'status warning';
                        this.log('Possible crash detected, confirming for 5 seconds');
                    }
                    if (Date.now() - this.crashStartTime > 5000) {
                        this.crashDetected = true;
                        this.triggerCrashAlert();
                    }
                } else {
                    if (this.crashStartTime) {
                        this.crashStartTime = null;
                        document.getElementById('crashStatus').textContent = 'Crash Detection: Inactive';
                        document.getElementById('crashStatus').className = 'status';
                        this.log('Crash condition cleared');
                    }
                }
            }
        });
    },

    startSession: function() {
        if (this.sessionActive) {
            this.log("Session already active", true);
            return;
        }
        
        this.sessionActive = true;
        this.sessionStartTime = new Date();
        this.sessionDistance = 0;
        this.sessionSpeeds = [];
        this.maxSpeed = 0;
        this.maxLeanAngle = 0;
        
        document.getElementById("startSessionBtn").disabled = true;
        document.getElementById("endSessionBtn").disabled = false;
        document.getElementById("saveSessionBtn").disabled = true;
        
        this.sessionEndTime = null;
        
        this.log("Bike session started");
        this.updateSessionUI();
    },

    updateSessionUI: function() {
        const startBtn = document.getElementById("startSessionBtn");
        const endBtn = document.getElementById("endSessionBtn");
        const saveBtn = document.getElementById("saveSessionBtn");
        
        if (this.sessionActive) {
            startBtn.disabled = true;
            endBtn.disabled = false;
            saveBtn.disabled = true;
            startBtn.textContent = "Session Active";
        } else {
            startBtn.disabled = false;
            endBtn.disabled = true;
            saveBtn.disabled = !this.sessionEndTime;
            startBtn.textContent = "Start Bike Session";
        }
    },

    endSession: function() {
        if (!this.sessionActive) {
            this.log("No active session to end", true);
            return;
        }
        
        this.sessionActive = false;
        this.sessionEndTime = new Date();
        const sessionDuration = this.sessionEndTime - this.sessionStartTime;
        
        const sessionData = {
            startTime: this.sessionStartTime,
            endTime: this.sessionEndTime,
            duration: sessionDuration,
            distance: this.sessionDistance,
            maxSpeed: this.maxSpeed,
            maxLeanAngle: this.maxLeanAngle,
            avgSpeed: this.sessionSpeeds.length > 0 ? 
                this.sessionSpeeds.reduce((a, b) => a + b, 0) / this.sessionSpeeds.length : 0
        };
        
        this.sessionHistory.push(sessionData);
        
        this.updateSessionUI();
        this.updateSessionHistory();
        
        this.log(`Bike session ended. Duration: ${this.formatDuration(sessionDuration)}, Distance: ${this.sessionDistance.toFixed(2)} km`);
    },

    saveSession: function() {
        if (this.sessionActive) {
            alert("Please end the session before saving.");
            return;
        }
        
        const sessionData = {
            startTime: this.sessionStartTime,
            duration: new Date() - this.sessionStartTime,
            distance: this.sessionDistance,
            maxSpeed: this.maxSpeed,
            maxLeanAngle: this.maxLeanAngle
        };
        
        this.sessionHistory.push(sessionData);
        this.saveData();
        this.updateSessionHistory();
        
        this.log("Session saved successfully");
    },

    setAccelerationTarget: function() {
        const target = parseInt(document.getElementById("accelerationTarget").value);
        if (target && target >= 20 && target <= 300) {
            this.accelerationTarget = target;
            this.updateAccelerationTarget();
            this.log(`Acceleration target set to 0-${target} km/h`);
        } else {
            alert("Please enter a valid acceleration target between 20 and 300 km/h");
        }
    },

    updateAccelerationTarget: function() {
        document.getElementById("accelerationLabel").textContent = `0-${this.accelerationTarget} km/h`;
        document.getElementById("statsAccelerationLabel").textContent = `0-${this.accelerationTarget} km/h:`;
    },

    formatDuration: function(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    },

    calibrateSensors: function() {
        this.isCalibrating = true;
        this.calibrationSamples = [];
        document.getElementById('calibrateStatus').textContent = 'Calibrating... Keep phone steady for 5 seconds.';
        this.log('Starting sensor calibration');

        setTimeout(() => {
            if (this.calibrationSamples.length > 0) {
                const avgGamma = this.calibrationSamples.reduce((a, b) => a + b, 0) / this.calibrationSamples.length;
                this.leanOffset = avgGamma;
                document.getElementById('calibrateStatus').textContent = 'Calibrated! Offset: ' + this.leanOffset.toFixed(1) + 'Â°';
                document.getElementById('calibrateStatus').className = 'status success';
                this.log('Calibration complete: offset ' + this.leanOffset.toFixed(1) + 'Â°');
            } else {
                document.getElementById('calibrateStatus').textContent = 'Calibration failed - no data';
                document.getElementById('calibrateStatus').className = 'status error';
                this.log('Calibration failed');
            }
            this.isCalibrating = false;
        }, 5000);
    },

    triggerCrashAlert: function() {
        document.getElementById('crashStatus').textContent = 'Crash detected! Sending alert...';
        document.getElementById('crashStatus').className = 'status error';
        this.log('Crash confirmed, triggering emergency alert');
        
        if (this.lastPosition) {
            const message = `CRASH DETECTED! ${document.getElementById('emergencyMessage').value} Lat: ${this.lastPosition.lat.toFixed(6)}, Lon: ${this.lastPosition.lon.toFixed(6)}`;
            this.sendEmergencyAlert(message);
        } else {
            this.log('No recent position available for crash alert', true);
            document.getElementById('crashStatus').textContent = 'Crash detected, but no position available';
        }
    },

    updateLeanAngleDisplay: function() {
        try {
            const leanBike = document.getElementById('leanBike');
            const leanValue = document.getElementById('leanValue');
            
            if (!leanBike || !leanValue) {
                this.log("Lean angle elements not found", true);
                return;
            }
            
            const displayAngle = Math.min(45, this.currentLeanAngle);
            leanBike.style.transform = `translateX(-50%) rotate(${displayAngle}deg)`;
            leanValue.textContent = `${this.currentLeanAngle}Â°`;
            
            if (this.currentLeanAngle > 40) {
                leanValue.style.color = 'var(--warning-color)';
            } else if (this.currentLeanAngle > 60) {
                leanValue.style.color = 'var(--error-color)';
            } else {
                leanValue.style.color = 'var(--accent-color)';
            }
        } catch (error) {
            this.log("Error updating lean display: " + error.message, true);
        }
    },

    updateWheelAnimation: function() {
        const wheel = document.querySelector('.spinning-wheel');
        const spokes = document.querySelectorAll('.wheel-spoke');
        if (this.currentSpeed <= 0.1) {
            wheel.style.animation = 'none';
            spokes.forEach(spoke => spoke.style.animation = 'none');
        } else {
            const speedKmh = this.currentSpeed * 3.6;
            this.rotationSpeed = Math.max(0.2, 2 / (speedKmh / 10));
            wheel.style.animation = `wheel-spin ${this.rotationSpeed}s linear infinite`;
            spokes.forEach((spoke, index) => {
                const spokeSpeed = this.rotationSpeed * (1 + index * 0.5);
                spoke.style.animation = `spoke-spin ${spokeSpeed}s linear infinite ${index % 2 === 0 ? '' : 'reverse'}`;
            });
        }
    },

    toggleMute: function() {
        this.isMuted = !this.isMuted;
        const muteBtn = document.getElementById("muteBtn");
        if (this.isMuted) {
            muteBtn.textContent = "Sound Muted";
            muteBtn.classList.add("muted");
            clearTimeout(this.bleepTimer);
            this.log("Audio muted");
        } else {
            muteBtn.textContent = "Mute Sound";
            muteBtn.classList.remove("muted");
            this.log("Audio unmuted");
        }
    },

    toggleAutoLock: function() {
        this.autoLockEnabled = !this.autoLockEnabled;
        if (this.autoLockEnabled) {
            document.getElementById("autoLockBtn").textContent = "Auto-Lock: ON";
            document.getElementById("autoLockBtn").style.backgroundColor = "#ff6600";
            document.getElementById("autoLockBtn").style.color = "#000";
            document.getElementById("autoLockSettings").style.display = "block";
            this.log("Auto-lock enabled - will lock when stopped for specified time");
            this.updateGpsStatus("Auto-lock enabled - will lock when stopped");
        } else {
            document.getElementById("autoLockBtn").textContent = "Auto-Lock Mode";
            document.getElementById("autoLockBtn").style.backgroundColor = "";
            document.getElementById("autoLockBtn").style.color = "";
            document.getElementById("autoLockSettings").style.display = "none";
            clearTimeout(this.autoLockDebounce);
            this.autoLockDebounce = null;
            this.isStationary = false;
            this.lastStationaryTime = null;
            this.lastStationaryPosition = null;
            this.speedThreshold = 10;
            document.getElementById("speedThreshold").value = 10;
            document.getElementById("speedThresholdValue").textContent = "10 km/h";
            this.log("Auto-lock disabled");
            this.updateGpsStatus("Auto-lock disabled");
        }
        this.updateUI();
    },

    initAudio: function() {
        if (this.audioCtx) {
            if (this.audioCtx.state === 'suspended') {
                this.audioCtx.resume().then(() => {
                    this.log("Audio context resumed");
                });
            }
            return;
        }
        try {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById("audioStatus").textContent = "Audio: Initialized";
            document.getElementById("audioStatus").className = "status success";
            document.getElementById("autoLockBtn").disabled = false;
            this.log("Audio system initialized");
        } catch (e) {
            document.getElementById("audioStatus").textContent = `Audio: ${e.message}`;
            document.getElementById("audioStatus").className = "status error";
            this.log(`Audio init error: ${e.message}`, true);
        }
    },

    playTestSound: function() {
        if (!this.audioCtx) {
            this.log("Audio context not ready", true);
            return;
        }
        try {
            const now = this.audioCtx.currentTime;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 800;
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(1, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
            this.isAudioAllowed = true;
            document.getElementById("audioStatus").textContent = "Audio: Working!";
            document.getElementById("audioStatus").className = "status success";
            document.getElementById("autoLockBtn").disabled = false;
            document.getElementById("muteBtn").disabled = false;
            this.log("Test sound played successfully - audio is enabled");
        } catch (e) {
            document.getElementById("audioStatus").textContent = `Audio: ${e.message}`;
            document.getElementById("audioStatus").className = "status error";
            this.log(`Test sound failed: ${e.message}`, true);
        }
    },

    playBleep: function(freq) {
        if (!this.audioCtx || !this.isAudioAllowed || this.isMuted) return;
        try {
            const now = this.audioCtx.currentTime;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.3, now + 0.01);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } catch (e) {
            this.log(`Bleep error: ${e.message}`, true);
        }
    },

    lockCurrentPosition: function() {
        if (!navigator.geolocation) {
            this.updateGpsStatus("Geolocation not supported", true);
            return;
        }
        this.updateGpsStatus("Getting position...");
        navigator.geolocation.getCurrentPosition(
            pos => {
                this.lockPosition = {
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                };
                this.updateGpsStatus(`Position locked! (Accuracy: ${this.lockPosition.accuracy.toFixed(1)}m)`);
                this.updateLockStatus(`Locked (Accuracy: ${this.lockPosition.accuracy.toFixed(1)}m)`);
                this.isActive = true;
                this.startPositionWatch();
                this.updateUI();
            },
            err => {
                let errorMsg = `Error: ${err.message}`;
                if (err.code === err.PERMISSION_DENIED) {
                    errorMsg = "Permission denied. Enable location services.";
                } else if (err.code === err.TIMEOUT) {
                    errorMsg = "Timeout. Ensure GPS is enabled.";
                } else if (err.code === err.POSITION_UNAVAILABLE) {
                    errorMsg = "Position unavailable. Try moving to open area.";
                }
                this.updateGpsStatus(errorMsg, true);
                this.log(`GPS error: ${err.code} - ${err.message}`, true);
            },
            { 
                enableHighAccuracy: true, 
                timeout: 10000,
                maximumAge: 0
            }
        );
    },

    startPositionWatch: function() {
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
        }
        this.watchId = navigator.geolocation.watchPosition(
            pos => this.handlePositionUpdate(pos),
            err => {
                this.updateGpsStatus(`GPS error: ${err.message}`, true);
            },
            { 
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 15000
            }
        );
    },

    handlePositionUpdate: function(pos) {
        const now = Date.now();
        this.lastUpdateTime = now;
        const { latitude, longitude, accuracy, speed } = pos.coords;
        this.currentSpeed = speed || 0;
        const speedKmh = (this.currentSpeed * 3.6).toFixed(1);
        
        const previousPosition = this.lastPosition;
        this.lastPosition = { lat: latitude, lon: longitude, accuracy };
        
        document.getElementById("currentSpeed").textContent = `${speedKmh} km/h`;
        document.getElementById("statsCurrentSpeed").textContent = `${speedKmh} km/h`;
        
        if (this.currentSpeed > this.maxSpeed) {
            this.maxSpeed = this.currentSpeed;
            document.getElementById("maxSpeed").textContent = `${(this.maxSpeed * 3.6).toFixed(1)} km/h`;
            document.getElementById("statsMaxSpeed").textContent = `${(this.maxSpeed * 3.6).toFixed(1)} km/h`;
        }
        
        if (this.sessionActive && previousPosition && this.lastPosition) {
            const distance = this.calculateDistance(
                latitude, longitude, 
                previousPosition.lat, previousPosition.lon
            );
            this.sessionDistance += distance / 1000;
            this.todayDistance += distance / 1000;
            this.totalDistance += distance / 1000;
            
            document.getElementById("todayDistance").textContent = `${this.todayDistance.toFixed(2)} km`;
            document.getElementById("statsToday").textContent = `${this.todayDistance.toFixed(2)} km`;
            document.getElementById("statsTotal").textContent = `${this.totalDistance.toFixed(2)} km`;
        }
        
        this.trackAcceleration(speedKmh);
        this.updateWheelAnimation();
        
        if (this.map) {
            const userPos = [latitude, longitude];
            this.userMarker.setLatLng(userPos);
            if (this.lockPosition) {
                const lockPos = [this.lockPosition.lat, this.lockPosition.lon];
                this.lockMarker.setLatLng(lockPos);
                this.line.setLatLngs([userPos, lockPos]);
                this.map.fitBounds([userPos, lockPos], { padding: [20, 20] });
            }
        }
        
        const threshold = this.speedThreshold * 1000 / 3600;
        const stationaryTime = parseFloat(document.getElementById("stationaryTime").value) * 1000;
        
        if (this.autoLockEnabled) {
            if (this.currentSpeed <= threshold && !this.isStationary) {
                this.isStationary = true;
                this.lastStationaryTime = now;
                this.lastStationaryPosition = { lat: latitude, lon: longitude, accuracy };
                this.log(`Stationary detected at ${speedKmh} km/h, waiting ${stationaryTime/1000}s to confirm lock`);
                this.updateGpsStatus(`Stationary, waiting ${stationaryTime/1000}s to lock`);
                clearTimeout(this.autoLockDebounce);
                this.autoLockDebounce = setTimeout(() => {
                    if (this.isStationary && this.currentSpeed <= threshold) {
                        this.lockPosition = this.lastStationaryPosition;
                        this.updateGpsStatus(`Auto-locked! (Speed: ${speedKmh} km/h, Accuracy: ${accuracy.toFixed(1)}m)`);
                        this.updateLockStatus(`Auto-locked (Accuracy: ${this.lockPosition.accuracy.toFixed(1)}m)`);
                        this.isActive = true;
                        this.log(`Auto-locked position at ${speedKmh} km/h`);
                    }
                }, stationaryTime);
            } else if (this.currentSpeed > threshold && this.isStationary) {
                this.isStationary = false;
                this.lastStationaryTime = null;
                clearTimeout(this.autoLockDebounce);
                this.autoLockDebounce = null;
                this.log(`Movement detected (${speedKmh} km/h), resetting stationary timer`);
                this.updateGpsStatus(`Moving (${speedKmh} km/h), stationary timer reset`);
                if (this.lockPosition) {
                    this.updateGpsStatus(`Keeping locked position (Speed: ${speedKmh} km/h)`);
                }
            } else if (this.currentSpeed > threshold && this.lockPosition) {
                this.log(`Moving with locked position (${speedKmh} km/h)`);
            }
        }
        
        if (!this.lockPosition || !this.isActive) {
            this.updateUI();
            return;
        }

        const distance = this.calculateDistance(latitude, longitude, this.lockPosition.lat, this.lockPosition.lon);
        
        if (distance < 5 && !this.reachedPointDisplayed) {
            document.getElementById("reachedMessage").style.display = "block";
            this.reachedPointDisplayed = true;
            this.log("You have reached the GPS locked point!");
        } else if (distance >= 5 && this.reachedPointDisplayed) {
            document.getElementById("reachedMessage").style.display = "none";
            this.reachedPointDisplayed = false;
        }
        
        this.movementHistory.push({ time: now, distance, speed: this.currentSpeed });
        this.movementHistory = this.movementHistory.filter(item => now - item.time < 5000);
        
        this.updateDirection(latitude, longitude);
        this.updateDisplay(distance, accuracy, this.currentSpeed);
        this.updateAudio(distance);
    },

    trackAcceleration: function(speedKmh) {
        const speedNum = parseFloat(speedKmh);
        if (speedNum < 5 && !this.accelerationStartTime) {
            this.accelerationStartTime = Date.now();
            this.accelerationStartSpeed = speedNum;
            this.log("Acceleration timer started");
        }
        if (speedNum >= this.accelerationTarget && this.accelerationStartTime) {
            const accelerationTime = (Date.now() - this.accelerationStartTime) / 1000;
            this.accelerationTimes.push(accelerationTime);
            const recentTimes = this.accelerationTimes.slice(-3);
            const avgTime = recentTimes.reduce((a, b) => a + b, 0) / recentTimes.length;
            document.getElementById("accelerationTime").textContent = `${avgTime.toFixed(1)} s`;
            document.getElementById("statsAcceleration").textContent = `${avgTime.toFixed(1)} s`;
            this.accelerationStartTime = null;
            this.log(`0-${this.accelerationTarget} km/h acceleration: ${accelerationTime.toFixed(1)}s`);
        }
        if (this.accelerationStartTime && speedNum < this.accelerationStartSpeed) {
            this.accelerationStartTime = null;
            this.log("Acceleration timer reset");
        }
    },

    updateDirection: function(currentLat, currentLon) {
        if (!this.lockPosition) return;
        const currentLatRad = currentLat * Math.PI/180;
        const currentLonRad = currentLon * Math.PI/180;
        const lockLatRad = this.lockPosition.lat * Math.PI/180;
        const lockLonRad = this.lockPosition.lon * Math.PI/180;
        const y = Math.sin(lockLonRad - currentLonRad) * Math.cos(lockLatRad);
        const x = Math.cos(currentLatRad) * Math.sin(lockLatRad) - 
                  Math.sin(currentLatRad) * Math.cos(lockLatRad) * Math.cos(lockLonRad - currentLonRad);
        let bearing = Math.atan2(y, x) * (180 / Math.PI);
        bearing = (bearing + 360) % 360;
        const arrow = document.getElementById("directionArrow");
        arrow.style.transform = `translate(-50%, -50%) rotate(${bearing}deg)`;
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        const index = Math.round(bearing / 45) % 8;
        document.getElementById("directionStatus").textContent = 
            `Direction: ${bearing.toFixed(1)}Â° (${directions[index]})`;
    },

    calculateDistance: function(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                  Math.cos(Ï†1) * Math.cos(Ï†2) *
                  Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    updateAudio: function(currentDistance) {
        clearTimeout(this.bleepTimer);
        if (!this.isAudioAllowed || !this.audioCtx || this.isMuted) {
            this.bleepTimer = setTimeout(() => {
                this.updateAudio(currentDistance);
            }, 1000);
            return;
        }
        const maxDist = this.getValidMaxDistance();
        const freq = this.getValidFrequency();
        const normalizedDist = Math.min(currentDistance, maxDist);
        const avgSpeedKmh = this.movementHistory.length > 0 ? 
            (this.movementHistory.reduce((sum, item) => sum + item.speed, 0) / this.movementHistory.length) * 3.6 : 0;
        const speedFactor = Math.min(3, Math.max(1, 1 + (avgSpeedKmh / 20)));
        const distanceFactor = 1 - (normalizedDist / maxDist);
        const baseTempo = 1500 - (1350 * distanceFactor);
        const dynamicTempo = baseTempo / speedFactor;
        this.currentTempo = Math.max(150, Math.min(1500, dynamicTempo));
        const bpm = Math.round(60000 / this.currentTempo);
        document.getElementById("bleepRate").textContent = bpm;
        this.playBleep(freq);
        this.bleepTimer = setTimeout(() => {
            this.updateAudio(currentDistance);
        }, this.currentTempo);
    },

    stop: function() {
        clearTimeout(this.bleepTimer);
        clearTimeout(this.autoLockDebounce);
        this.autoLockDebounce = null;
        if (this.watchId) {
            navigator.geolocation.clearWatch(this.watchId);
            this.watchId = null;
        }
        this.isActive = false;
        this.lockPosition = null;
        this.autoLockEnabled = false;
        this.isMuted = false;
        this.isStationary = false;
        this.lastStationaryTime = null;
        this.lastStationaryPosition = null;
        this.crashDetected = false;
        this.crashStartTime = null;
        this.speedThreshold = 10;
        document.getElementById("speedThreshold").value = 10;
        document.getElementById("speedThresholdValue").textContent = "10 km/h";
        document.getElementById("autoLockBtn").textContent = "Auto-Lock Mode";
        document.getElementById("autoLockBtn").style.backgroundColor = "";
        document.getElementById("autoLockBtn").style.color = "";
        document.getElementById("autoLockSettings").style.display = "none";
        document.getElementById("muteBtn").textContent = "Mute Sound";
        document.getElementById("muteBtn").classList.remove("muted");
        document.getElementById("crashStatus").textContent = "Crash Detection: Inactive";
        document.getElementById("crashStatus").className = "status";
        this.updateGpsStatus("Stopped");
        this.updateLockStatus("Not locked");
        this.updateUI();
        this.reachedPointDisplayed = false;
        document.getElementById("reachedMessage").style.display = "none";
        this.updateWheelAnimation();
        this.log("Position tracking stopped");
    },

    updateDisplay: function(distance, accuracy, speed) {
        document.getElementById("distance").textContent = distance.toFixed(1);
        document.getElementById("accuracy").textContent = accuracy ? accuracy.toFixed(1) : '--';
    },

    updateGpsStatus: function(message, isError = false) {
        const statusEl = document.getElementById("gpsStatus");
        statusEl.textContent = `GPS: ${message}`;
        statusEl.className = isError ? "status error" : "status";
    },

    updateLockStatus: function(message, isError = false) {
        const statusEl = document.getElementById("lockStatus");
        statusEl.textContent = `Lock Status: ${message}`;
        statusEl.className = isError ? "status error" : "status";
    },

    updateUI: function() {
        document.getElementById("stopBtn").disabled = !this.isActive;
        document.getElementById("muteBtn").disabled = !this.isActive || !this.isAudioAllowed;
    },

    getValidFrequency: function() {
        const freq = parseFloat(document.getElementById("freqInput").value);
        return Math.min(20000, Math.max(20, isNaN(freq) ? 800 : freq));
    },

    getValidMaxDistance: function() {
        const dist = parseFloat(document.getElementById("maxDistInput").value);
        return Math.max(1, isNaN(dist) ? 50 : dist);
    },

    resetMetrics: function() {
        this.maxSpeed = 0;
        this.totalDistance = 0;
        this.todayDistance = 0;
        this.weekDistance = 0;
        this.monthDistance = 0;
        this.accelerationTimes = [];
        this.maxLeanAngle = 0;
        this.currentLeanAngle = 0;
        this.updateMetricsDisplay();
        this.log("All metrics reset");
    },

    exportMetrics: function() {
        const data = {
            maxSpeed: this.maxSpeed,
            totalDistance: this.totalDistance,
            accelerationTimes: this.accelerationTimes,
            maxLeanAngle: this.maxLeanAngle,
            rideHistory: this.rideHistory
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "motofindback_metrics.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        this.log("Metrics exported");
    },

    sendEmergencyAlert: function(customMessage = null) {
        const defaultMessage = document.getElementById("emergencyMessage").value;
        const message = customMessage || defaultMessage;
        const contacts = document.getElementById("emergencyContacts").value.split(',').map(c => c.trim());
        if (contacts.length === 0 || contacts[0] === "") {
            this.log("No emergency contacts set", true);
            document.getElementById('crashStatus').textContent = 'Crash Detection: No contacts set';
            document.getElementById('crashStatus').className = 'status error';
            return;
        }
        contacts.forEach(contact => {
            this.log(`Emergency message sent to ${contact}: ${message}`);
        });
        alert("Emergency alert sent to your contacts!");
        if (this.crashDetected) {
            document.getElementById('crashStatus').textContent = 'Crash alert sent';
            document.getElementById('crashStatus').className = 'status success';
        }
    },

    testEmergency: function() {
        this.log("TEST: Emergency system checked - would send alerts to contacts");
        alert("Emergency system test completed successfully");
    },

    addEmergencyContact: function() {
        const contact = prompt("Enter emergency contact number:");
        if (contact) {
            this.emergencyContacts.push(contact);
            this.updateEmergencyContactsDisplay();
            this.log(`Emergency contact added: ${contact}`);
        }
    },

    updateEmergencyContactsDisplay: function() {
        const contactList = document.getElementById("emergencyContactList");
        contactList.innerHTML = "";
        this.emergencyContacts.forEach(contact => {
            const contactItem = document.createElement("div");
            contactItem.className = "contact-item";
            contactItem.innerHTML = `
                <div>${contact}</div>
                <button onclick="MotoFindBack.removeEmergencyContact('${contact}')">Remove</button>
            `;
            contactList.appendChild(contactItem);
        });
    },

    removeEmergencyContact: function(contact) {
        this.emergencyContacts = this.emergencyContacts.filter(c => c !== contact);
        this.updateEmergencyContactsDisplay();
        this.log(`Emergency contact removed: ${contact}`);
    },

    showMaintenanceForm: function() {
        const form = document.querySelector('#maintenance-tab .control-item');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    },

    saveMaintenanceItem: function() {
        const name = document.getElementById("newMaintenanceName").value;
        const interval = parseInt(document.getElementById("newMaintenanceInterval").value);
        if (name && interval) {
            this.maintenanceItems.push({
                name,
                interval,
                current: 0
            });
            this.updateMaintenanceDisplay();
            document.getElementById("newMaintenanceName").value = "";
            document.getElementById("newMaintenanceInterval").value = "";
            this.log(`Maintenance item added: ${name} (every ${interval} km)`);
        }
    },

    resetMaintenance: function() {
        this.maintenanceItems = [];
        this.updateMaintenanceDisplay();
        this.log("All maintenance items reset");
    },

    updateMaintenanceDisplay: function() {
        const maintenanceList = document.getElementById("maintenanceList");
        maintenanceList.innerHTML = "";
        this.maintenanceItems.forEach(item => {
            const progress = (item.current / item.interval) * 100;
            const itemEl = document.createElement("div");
            itemEl.className = "maintenance-item";
            itemEl.innerHTML = `
                <div>${item.name}</div>
                <div class="maintenance-progress">
                    <div class="maintenance-progress-bar" style="width: ${progress}%;"></div>
                </div>
                <div>${item.current}/${item.interval} km</div>
            `;
            maintenanceList.appendChild(itemEl);
        });
    },

    updateMetricsDisplay: function() {
        document.getElementById("todayDistance").textContent = `${this.todayDistance.toFixed(1)} km`;
        document.getElementById("statsToday").textContent = `${this.todayDistance.toFixed(1)} km`;
        document.getElementById("statsWeek").textContent = `${this.weekDistance.toFixed(1)} km`;
        document.getElementById("statsMonth").textContent = `${this.monthDistance.toFixed(1)} km`;
        document.getElementById("statsTotal").textContent = `${this.totalDistance.toFixed(1)} km`;
        document.getElementById("maxSpeed").textContent = `${(this.maxSpeed * 3.6).toFixed(1)} km/h`;
        document.getElementById("statsMaxSpeed").textContent = `${(this.maxSpeed * 3.6).toFixed(1)} km/h`;
        if (this.rideHistory.length > 0) {
            const totalSpeed = this.rideHistory.reduce((sum, ride) => sum + ride.avgSpeed, 0);
            const avgSpeed = totalSpeed / this.rideHistory.length;
            document.getElementById("avgSpeed").textContent = `${avgSpeed.toFixed(1)} km/h`;
            document.getElementById("statsAvgSpeed").textContent = `${avgSpeed.toFixed(1)} km/h`;
        }
    },

    loadData: function() {
        try {
            const savedData = localStorage.getItem('spinAppData');
            if (savedData) {
                const data = JSON.parse(savedData);
                this.todayDistance = data.todayDistance || 0;
                this.totalDistance = data.totalDistance || 0;
                this.sessionHistory = data.sessionHistory || [];
                this.emergencyContacts = data.emergencyContacts || [];
                this.maintenanceItems = data.maintenanceItems || [];
                this.accelerationTarget = data.accelerationTarget || 100;
                
                this.updateMetricsDisplay();
                this.updateSessionHistory();
                this.updateEmergencyContactsDisplay();
                this.updateMaintenanceDisplay();
                this.updateAccelerationTarget();
                
                this.log("Data loaded from storage");
            }
        } catch (e) {
            this.log("Error loading data: " + e.message, true);
        }
    },

    saveData: function() {
        try {
            const data = {
                todayDistance: this.todayDistance,
                totalDistance: this.totalDistance,
                sessionHistory: this.sessionHistory,
                emergencyContacts: this.emergencyContacts,
                maintenanceItems: this.maintenanceItems,
                accelerationTarget: this.accelerationTarget
            };
            
            localStorage.setItem('spinAppData', JSON.stringify(data));
            this.log("Data saved to storage");
        } catch (e) {
            this.log("Error saving data: " + e.message, true);
        }
    },

    log: function(message, isError = false) {
        const debugEl = document.getElementById("debug");
        const entry = document.createElement('div');
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        entry.style.color = isError ? '#ff3333' : '#00ccff';
        debugEl.prepend(entry);
        if (debugEl.children.length > 20) {
            debugEl.removeChild(debugEl.lastChild);
        }
    }
};

document.addEventListener('DOMContentLoaded', () => {
    MotoFindBack.init();
    if (/Mobi|Android/i.test(navigator.userAgent)) {
        MotoFindBack.log("MOBILE DETECTED: Mount your phone securely for accurate lean angles and crash detection", false);
    }
});
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('ServiceWorker registration successful');
        })
        .catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
    });
  }
</script>
</body>
</html>
